{% extends "base.html" %}

{% block title %}RRD Graphs - {{ dashboard_name }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chart-area"></i> RRD Traffic Graphs</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="metric-select">
                        <option value="tcp">TCP Traffic</option>
                        <option value="udp">UDP Traffic</option>
                        <option value="icmp">ICMP Traffic</option>
                        <option value="total">Total Traffic</option>
                    </select>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="timespan-select">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                    <button class="btn btn-sm btn-primary" id="refresh-graph">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="graph-container" class="text-center">
                    <img id="rrd-graph" src="" alt="RRD Graph" class="img-fluid" style="max-width: 100%; height: auto;">
                    <div id="graph-loading" class="mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading graph...</p>
                    </div>
                    <div id="graph-error" class="alert alert-warning mt-3" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> <span id="error-message"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Traffic Statistics Cards -->
<div class="row">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-network-wired fa-3x text-primary mb-2"></i>
                <h4 id="tcp-flows">-</h4>
                <p class="text-muted">TCP Flows</p>
                <small class="text-muted" id="tcp-packets">- packets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-exchange-alt fa-3x text-info mb-2"></i>
                <h4 id="udp-flows">-</h4>
                <p class="text-muted">UDP Flows</p>
                <small class="text-muted" id="udp-packets">- packets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-broadcast-tower fa-3x text-success mb-2"></i>
                <h4 id="icmp-flows">-</h4>
                <p class="text-muted">ICMP Flows</p>
                <small class="text-muted" id="icmp-packets">- packets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-2"></i>
                <h4 id="total-alerts">-</h4>
                <p class="text-muted">Total Alerts</p>
                <small class="text-muted" id="last-update">Last update: -</small>
            </div>
        </div>
    </div>
</div>

<!-- Database Traffic Stats Table -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> Recent Traffic Statistics (from Database)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Protocol</th>
                                <th>Flows</th>
                                <th>Packets</th>
                                <th>Bytes</th>
                                <th>Alerts</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body">
                            <tr>
                                <td colspan="6" class="text-center">Loading statistics...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMetric = 'tcp';
let currentTimespan = '1h';

function loadGraph() {
    const metric = $('#metric-select').val();
    const timespan = $('#timespan-select').val();

    currentMetric = metric;
    currentTimespan = timespan;

    $('#graph-loading').show();
    $('#graph-error').hide();
    $('#rrd-graph').hide();

    const graphUrl = `/api/monitor/graph/${metric}/${timespan}?t=${Date.now()}`;

    // Load graph image
    const img = new Image();
    img.onload = function() {
        $('#rrd-graph').attr('src', graphUrl).show();
        $('#graph-loading').hide();
    };
    img.onerror = function() {
        $('#graph-loading').hide();
        $('#graph-error').show();
        $('#error-message').text('Failed to load RRD graph. Make sure RRD data is available.');
    };
    img.src = graphUrl;
}

function loadTrafficStats() {
    $.get('/api/database/traffic/latest', function(response) {
        if (response.success) {
            const stats = response.stats;

            // Update TCP stats
            if (stats.tcp) {
                $('#tcp-flows').text(stats.tcp.flow_count || 0);
                $('#tcp-packets').text(`${stats.tcp.packet_count || 0} packets`);
            }

            // Update UDP stats
            if (stats.udp) {
                $('#udp-flows').text(stats.udp.flow_count || 0);
                $('#udp-packets').text(`${stats.udp.packet_count || 0} packets`);
            }

            // Update ICMP stats
            if (stats.icmp) {
                $('#icmp-flows').text(stats.icmp.flow_count || 0);
                $('#icmp-packets').text(`${stats.icmp.packet_count || 0} packets`);
            }

            // Update total alerts
            const totalAlerts = (stats.tcp?.alert_count || 0) +
                               (stats.udp?.alert_count || 0) +
                               (stats.icmp?.alert_count || 0);
            $('#total-alerts').text(totalAlerts);

            // Update last update time
            const lastUpdate = stats.tcp?.timestamp || stats.udp?.timestamp || stats.icmp?.timestamp;
            if (lastUpdate) {
                $('#last-update').text(`Last update: ${new Date(lastUpdate).toLocaleString()}`);
            }
        }
    }).fail(function() {
        console.error('Failed to load traffic stats');
    });
}

function loadRecentStats() {
    $.get('/api/database/traffic/recent?limit=20', function(response) {
        if (response.success && response.stats.length > 0) {
            let html = '';
            response.stats.forEach(stat => {
                const timestamp = new Date(stat.timestamp).toLocaleString();
                const bytes = formatBytes(stat.byte_count);

                html += `
                    <tr>
                        <td><small>${timestamp}</small></td>
                        <td><span class="badge bg-secondary">${stat.protocol}</span></td>
                        <td>${stat.flow_count}</td>
                        <td>${stat.packet_count.toLocaleString()}</td>
                        <td>${bytes}</td>
                        <td>${stat.alert_count}</td>
                    </tr>
                `;
            });
            $('#stats-table-body').html(html);
        } else {
            $('#stats-table-body').html('<tr><td colspan="6" class="text-center text-muted">No traffic statistics available</td></tr>');
        }
    }).fail(function() {
        $('#stats-table-body').html('<tr><td colspan="6" class="text-center text-warning">Failed to load statistics from database</td></tr>');
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

$(document).ready(function() {
    // Load initial graph
    loadGraph();
    loadTrafficStats();
    loadRecentStats();

    // Refresh button
    $('#refresh-graph').click(function() {
        loadGraph();
        loadTrafficStats();
        loadRecentStats();
    });

    // Metric/timespan change
    $('#metric-select, #timespan-select').change(function() {
        loadGraph();
    });

    // Auto-refresh every 60 seconds
    setInterval(function() {
        loadGraph();
        loadTrafficStats();
        loadRecentStats();
    }, 60000);
});
</script>
{% endblock %}
