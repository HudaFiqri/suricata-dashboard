{% extends "base.html" %}
{% block title %}Configuration - Suricata Dashboard{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-list"></i> Quick Navigation</h6>
            </div>
            <div class="card-body p-2">
                <div class="list-group list-group-flush" id="config-nav">
                    <!-- Suricata Config Group -->
                    <div class="list-group-item list-group-item-secondary text-uppercase fw-bold small">
                        <i class="fas fa-cog"></i> Suricata Config
                    </div>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="af-packet">
                        <i class="fas fa-network-wired"></i> AF-Packet
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="app-layer">
                        <i class="fas fa-layer-group"></i> App Layer
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="outputs">
                        <i class="fas fa-file-export"></i> Outputs
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="logging">
                        <i class="fas fa-clipboard-list"></i> Logging
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="vars">
                        <i class="fas fa-dollar-sign"></i> Variables
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="detection">
                        <i class="fas fa-shield-alt"></i> Detection
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="stream">
                        <i class="fas fa-stream"></i> Stream
                    </a>
                    <a href="#" class="list-group-item list-group-item-action config-search" data-search="host">
                        <i class="fas fa-server"></i> Host
                    </a>

                    <!-- Integration Group -->
                    <div class="list-group-item list-group-item-secondary text-uppercase fw-bold small mt-2">
                        <i class="fas fa-plug"></i> Integration
                    </div>
                    <a href="#" class="list-group-item list-group-item-action" data-integration="discord">
                        <i class="fab fa-discord"></i> Discord
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-integration="telegram">
                        <i class="fab fa-telegram"></i> Telegram
                    </a>
                </div>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Info</h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <p><strong>Format:</strong> YAML</p>
                    <p><strong>Tip:</strong> Use Ctrl+F to search</p>
                    <p class="mb-0"><strong>Line Count:</strong> <span id="line-count">0</span></p>
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-cog"></i> Suricata Configuration</h5>
                <div>
                    <button class="btn btn-sm btn-primary" id="save-config-btn">
                        <i class="fas fa-save"></i> Save Config
                    </button>
                    <button class="btn btn-sm btn-secondary" id="reload-config-btn">
                        <i class="fas fa-sync"></i> Reload
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="alert alert-warning m-3 mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> Modifying the configuration requires careful attention.
                    Invalid configurations may prevent Suricata from starting.
                </div>
                <div id="editor-container" style="position: relative; height: 600px; border-top: 1px solid #dee2e6;">
                    <textarea id="config-editor" class="form-control h-100 border-0" style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; resize: none; padding: 15px;">Loading configuration...</textarea>
                </div>
                <div class="border-top p-2 bg-light">
                    <small class="text-muted">
                        <i class="fas fa-keyboard"></i> Press Ctrl+S to save |
                        <i class="fas fa-search"></i> Press Ctrl+F to search
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="integrationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="integrationModalLabel">Integration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="integration-error"></div>
                <div class="alert alert-success d-none" id="integration-success"></div>
                <div class="text-muted small d-none" id="integration-hash-wrapper">
                    MD5 Hash: <code id="integration-hash-value">-</code>
                </div>
                <input type="hidden" id="integration-name">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="integration-enabled">
                    <label class="form-check-label" for="integration-enabled">Enable integration</label>
                </div>
                <div id="discord-fields" class="integration-fields d-none">
                    <div class="mb-3">
                        <label for="discord-webhook" class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="discord-webhook" placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">Provide a Discord webhook URL with notification permissions.</div>
                    </div>
                    <div class="mb-3">
                        <label for="discord-template" class="form-label">Custom Message Template (Optional)</label>
                        <textarea class="form-control font-monospace" id="discord-template" rows="6" placeholder="ðŸš¨ Security Alert&#10;&#10;Signature: {signature}&#10;Category: {category}&#10;Severity: {severity}&#10;Source: {src_ip}:{src_port}&#10;Destination: {dest_ip}:{dest_port}&#10;Protocol: {protocol}"></textarea>
                        <div class="form-text">
                            Available variables: {signature}, {category}, {severity}, {src_ip}, {src_port}, {dest_ip}, {dest_port}, {protocol}, {timestamp}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate Limiting</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="discord-rate-limit-messages" class="form-label small">Max Messages</label>
                                <input type="number" class="form-control form-control-sm" id="discord-rate-limit-messages" value="30" min="1" max="100">
                                <div class="form-text">Maximum messages allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="discord-rate-limit-interval" class="form-label small">Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="discord-rate-limit-interval" value="60" min="10" max="3600">
                                <div class="form-text">Time window in seconds</div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Default: 30 messages per 60 seconds
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-info" id="discord-test-btn">
                            <i class="fas fa-paper-plane"></i> Test Send Message
                        </button>
                    </div>
                </div>
                <div id="telegram-fields" class="integration-fields d-none">
                    <div class="mb-3">
                        <label for="telegram-bot-token" class="form-label">Bot Token</label>
                        <input type="text" class="form-control" id="telegram-bot-token" placeholder="123456789:ABCDEF...">
                    </div>
                    <div class="mb-3">
                        <label for="telegram-chat-id" class="form-label">Chat ID</label>
                        <input type="text" class="form-control" id="telegram-chat-id" placeholder="@channel or numeric chat id">
                        <div class="form-text">Use the numeric chat ID or channel handle for the target destination.</div>
                    </div>
                    <div class="mb-3">
                        <label for="telegram-template" class="form-label">Custom Message Template (Optional)</label>
                        <textarea class="form-control font-monospace" id="telegram-template" rows="6" placeholder="ðŸš¨ Security Alert&#10;&#10;Signature: {signature}&#10;Category: {category}&#10;Severity: {severity}&#10;Source: {src_ip}:{src_port}&#10;Destination: {dest_ip}:{dest_port}&#10;Protocol: {protocol}"></textarea>
                        <div class="form-text">
                            Available variables: {signature}, {category}, {severity}, {src_ip}, {src_port}, {dest_ip}, {dest_port}, {protocol}, {timestamp}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate Limiting</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="telegram-rate-limit-messages" class="form-label small">Max Messages</label>
                                <input type="number" class="form-control form-control-sm" id="telegram-rate-limit-messages" value="20" min="1" max="100">
                                <div class="form-text">Maximum messages allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="telegram-rate-limit-interval" class="form-label small">Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="telegram-rate-limit-interval" value="60" min="10" max="3600">
                                <div class="form-text">Time window in seconds</div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Default: 20 messages per 60 seconds
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-info" id="telegram-test-btn">
                            <i class="fas fa-paper-plane"></i> Test Send Message
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="integration-save-btn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuration Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="config-modal-message">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- App Layer Config Modal -->
<div class="modal fade" id="appLayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> App Layer Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Enable/disable application layer protocols for deep packet inspection.
                </div>
                <div class="alert alert-danger d-none" id="app-layer-error"></div>
                <div class="alert alert-success d-none" id="app-layer-success"></div>

                <div id="app-layer-protocols-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading protocols...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-app-layer-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Outputs Config Modal -->
<div class="modal fade" id="outputsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-export"></i> Outputs Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure logging outputs for Suricata events and alerts.
                </div>
                <div class="alert alert-danger d-none" id="outputs-error"></div>
                <div class="alert alert-success d-none" id="outputs-success"></div>

                <div id="outputs-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading outputs...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="save-outputs-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Logging Modal -->
<div class="modal fade" id="loggingModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> Logging Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure Suricata logging system and output destinations.
                </div>
                <div class="alert alert-danger d-none" id="logging-error"></div>
                <div class="alert alert-success d-none" id="logging-success"></div>

                <div id="logging-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading logging configuration...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="save-logging-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detection Modal -->
<div class="modal fade" id="detectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-search"></i> Detection Engine Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure detection engine settings including profile, threading, and performance tuning.
                </div>
                <div class="alert alert-danger d-none" id="detection-error"></div>
                <div class="alert alert-success d-none" id="detection-success"></div>

                <div id="detection-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading detection configuration...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="save-detection-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const integrationDefaults = {
    discord: {
        enabled: false,
        webhook_url: '',
        message_template: '',
        rate_limit_messages: 30,
        rate_limit_interval: 60
    },
    telegram: {
        enabled: false,
        bot_token: '',
        chat_id: '',
        message_template: '',
        rate_limit_messages: 20,
        rate_limit_interval: 60
    }
};
let integrationSettings = {};
let integrationHashes = {};
let integrationModalInstance = null;
function loadConfig() {
    $.get('/api/config', function(data) {
        if (data.config !== undefined) {
            $('#config-editor').val(data.config);
            updateLineCount();
        } else if (data.error) {
            $('#config-editor').val('Error loading configuration: ' + data.error);
        }
    }).fail(function() {
        $('#config-editor').val('Failed to load configuration');
    });
}
function updateLineCount() {
    const lines = $('#config-editor').val().split('\n').length;
    $('#line-count').text(lines);
}
function showConfigResult(message, isSuccess = true) {
    $('#config-modal-message').html('<div class="alert alert-' + (isSuccess ? 'success' : 'danger') + '">' + message + '</div>');
    $('#configModal').modal('show');
}
function saveConfig() {
    const config = $('#config-editor').val();
    $.ajax({
        url: '/api/config',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({config: config}),
        success: function(data) {
            showConfigResult(data.message, data.success);
        },
        error: function() {
            showConfigResult('Failed to save configuration', false);
        }
    });
}
function loadIntegrationSettings() {
    $.get('/api/integration', function(response) {
        if (response.success && response.settings) {
            integrationSettings = response.settings;
            integrationHashes = response.hashes || {};
        }
    }).fail(function(xhr) {
        console.warn('Failed to load integration settings', xhr.responseText || xhr.statusText);
    });
}
function getIntegrationData(name) {
    const defaults = integrationDefaults[name] || {};
    const stored = integrationSettings[name] || {};
    return Object.assign({}, defaults, stored);
}
function resetIntegrationFeedback() {
    $('#integration-error').addClass('d-none').text('');
    $('#integration-success').addClass('d-none').text('');
}
function hideIntegrationHash() {
    $('#integration-hash-wrapper').addClass('d-none');
    $('#integration-hash-value').text('-');
}

function updateIntegrationHashDisplay(info) {
    if (info && info.config_hash) {
        $('#integration-hash-wrapper').removeClass('d-none');
        $('#integration-hash-value').text(info.config_hash);
    } else {
        hideIntegrationHash();
    }
}
function setIntegrationFeedback(message, type) {
    if (!message) {
        resetIntegrationFeedback();
        return;
    }
    if (type === 'success') {
        $('#integration-success').removeClass('d-none').text(message);
        $('#integration-error').addClass('d-none').text('');
    } else {
        $('#integration-error').removeClass('d-none').text(message);
        $('#integration-success').addClass('d-none').text('');
    }
}
function toggleIntegrationFields(name) {
    $('.integration-fields').addClass('d-none');
    if (name === 'discord') {
        $('#discord-fields').removeClass('d-none');
    } else if (name === 'telegram') {
        $('#telegram-fields').removeClass('d-none');
    }
}
function openIntegrationModal(name) {
    const normalized = (name || '').toLowerCase();
    const data = getIntegrationData(normalized);
    if (!integrationModalInstance) {
        integrationModalInstance = new bootstrap.Modal(document.getElementById('integrationModal'));
    }
    $('#integration-name').val(normalized);
    $('#integrationModalLabel').text(normalized === 'telegram' ? 'Telegram Integration' : 'Discord Integration');
    $('#integration-enabled').prop('checked', !!data.enabled);
    $('#discord-webhook').val(data.webhook_url || '');
    $('#discord-template').val(data.message_template || '');
    $('#discord-rate-limit-messages').val(data.rate_limit_messages || 30);
    $('#discord-rate-limit-interval').val(data.rate_limit_interval || 60);
    $('#telegram-bot-token').val(data.bot_token || '');
    $('#telegram-chat-id').val(data.chat_id || '');
    $('#telegram-template').val(data.message_template || '');
    $('#telegram-rate-limit-messages').val(data.rate_limit_messages || 20);
    $('#telegram-rate-limit-interval').val(data.rate_limit_interval || 60);
    updateIntegrationHashDisplay(integrationHashes[normalized]);
    toggleIntegrationFields(normalized);
    resetIntegrationFeedback();
    integrationModalInstance.show();
}
function collectIntegrationPayload(name) {
    const normalized = (name || '').toLowerCase();
    const payload = { enabled: $('#integration-enabled').is(':checked') };
    if (normalized === 'discord') {
        payload.webhook_url = ($('#discord-webhook').val() || '').trim();
        payload.message_template = ($('#discord-template').val() || '').trim();
        payload.rate_limit_messages = parseInt($('#discord-rate-limit-messages').val() || 30);
        payload.rate_limit_interval = parseInt($('#discord-rate-limit-interval').val() || 60);
    } else if (normalized === 'telegram') {
        payload.bot_token = ($('#telegram-bot-token').val() || '').trim();
        payload.chat_id = ($('#telegram-chat-id').val() || '').trim();
        payload.message_template = ($('#telegram-template').val() || '').trim();
        payload.rate_limit_messages = parseInt($('#telegram-rate-limit-messages').val() || 20);
        payload.rate_limit_interval = parseInt($('#telegram-rate-limit-interval').val() || 60);
    }
    return payload;
}
function setIntegrationSaving(isSaving) {
    const $btn = $('#integration-save-btn');
    if (isSaving) {
        if (!$btn.data('original-html')) {
            $btn.data('original-html', $btn.html());
        }
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');
    } else {
        const original = $btn.data('original-html');
        if (original) {
            $btn.html(original);
        }
        $btn.prop('disabled', false);
    }
}
function saveIntegration() {
    const name = $('#integration-name').val();
    if (!name) {
        return;
    }
    const payload = collectIntegrationPayload(name);
    setIntegrationSaving(true);
    resetIntegrationFeedback();
    $.ajax({
        url: '/api/integration/' + name,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
            if (response.success) {
                integrationSettings[name] = response.settings || payload;
                if (response.hash) {
                    integrationHashes[name] = response.hash;
                    updateIntegrationHashDisplay(response.hash);
                } else if (integrationHashes[name]) {
                    updateIntegrationHashDisplay(integrationHashes[name]);
                } else {
                    hideIntegrationHash();
                }
                setIntegrationFeedback('Settings saved successfully.', 'success');
            } else {
                setIntegrationFeedback(response.message || 'Failed to save settings.', 'error');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || xhr.responseText || 'Failed to save settings.';
            setIntegrationFeedback(message, 'error');
        },
        complete: function() {
            setIntegrationSaving(false);
        }
    });
}
$('#save-config-btn').click(saveConfig);
$('#reload-config-btn').click(function() {
    if (confirm('Reload configuration from file? Any unsaved changes will be lost.')) {
        loadConfig();
    }
});
$('#integration-save-btn').click(saveIntegration);
$('#integrationModal').on('hidden.bs.modal', function() {
    $('#integration-name').val('');
    $('#integration-enabled').prop('checked', false);
    $('#discord-webhook, #discord-template, #telegram-bot-token, #telegram-chat-id, #telegram-template').val('');
    $('#discord-rate-limit-messages').val(30);
    $('#discord-rate-limit-interval').val(60);
    $('#telegram-rate-limit-messages').val(20);
    $('#telegram-rate-limit-interval').val(60);
    hideIntegrationHash();
    resetIntegrationFeedback();
    setIntegrationSaving(false);
});

// Test send message functions
function testSendMessage(integration) {
    const name = integration.toLowerCase();
    let payload = {};

    if (name === 'telegram') {
        const bot_token = $('#telegram-bot-token').val().trim();
        const chat_id = $('#telegram-chat-id').val().trim();
        const template = $('#telegram-template').val().trim();

        if (!bot_token || !chat_id) {
            setIntegrationFeedback('Please fill in Bot Token and Chat ID first', 'error');
            return;
        }

        if (template) {
            payload.message = template;
        }
    } else if (name === 'discord') {
        const webhook_url = $('#discord-webhook').val().trim();
        const template = $('#discord-template').val().trim();

        if (!webhook_url) {
            setIntegrationFeedback('Please fill in Webhook URL first', 'error');
            return;
        }

        if (template) {
            payload.message = template;
        }
    }

    resetIntegrationFeedback();

    // Show loading state
    const btnId = '#' + name + '-test-btn';
    const $btn = $(btnId);
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Sending...');

    // First save the settings to ensure we test with current config
    const savePayload = collectIntegrationPayload(name);

    $.ajax({
        url: '/api/integration/' + name,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(savePayload),
        success: function(response) {
            // Now send test message
            $.ajax({
                url: '/api/integration/' + name + '/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(data) {
                    if (data.success) {
                        setIntegrationFeedback(data.message, 'success');
                    } else {
                        setIntegrationFeedback(data.message, 'error');
                    }
                },
                error: function(xhr) {
                    const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to send test message';
                    setIntegrationFeedback(message, 'error');
                },
                complete: function() {
                    $btn.prop('disabled', false).html(originalHtml);
                }
            });
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save settings';
            setIntegrationFeedback(message, 'error');
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#telegram-test-btn').click(function() {
    testSendMessage('telegram');
});

$('#discord-test-btn').click(function() {
    testSendMessage('discord');
});
$('.config-search').click(function(e) {
    e.preventDefault();
    const searchTerm = $(this).data('search');

    // Special handling for modals - open modal instead of searching
    if (searchTerm === 'app-layer') {
        $('#config-nav .list-group-item').removeClass('active');
        $(this).addClass('active');
        openAppLayerModal();
        return;
    }

    if (searchTerm === 'outputs') {
        $('#config-nav .list-group-item').removeClass('active');
        $(this).addClass('active');
        openOutputsModal();
        return;
    }

    if (searchTerm === 'logging') {
        $('#config-nav .list-group-item').removeClass('active');
        $(this).addClass('active');
        openLoggingModal();
        return;
    }

    if (searchTerm === 'detection') {
        $('#config-nav .list-group-item').removeClass('active');
        $(this).addClass('active');
        openDetectionModal();
        return;
    }

    // Default behavior: search in YAML editor
    const editor = $('#config-editor')[0];
    const content = editor.value;
    const lines = content.split('\n');
    let lineNumber = -1;
    let charPosition = 0;
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].toLowerCase().includes(searchTerm.toLowerCase())) {
            lineNumber = i;
            break;
        }
        charPosition += lines[i].length + 1;
    }
    if (lineNumber !== -1) {
        editor.focus();
        const lineHeight = parseInt(window.getComputedStyle(editor).lineHeight);
        const scrollPosition = lineNumber * lineHeight;
        editor.scrollTop = scrollPosition - 100;
        const lineStart = charPosition;
        const lineEnd = charPosition + lines[lineNumber].length;
        editor.setSelectionRange(lineStart, lineEnd);
        $('#config-nav .list-group-item').removeClass('active');
        $(this).addClass('active');
    } else {
        alert('Section "' + searchTerm + '" not found in configuration');
    }
});
$('#config-nav').on('click', '[data-integration]', function(e) {
    e.preventDefault();
    const target = $(this).data('integration');
    $('#config-nav .list-group-item').removeClass('active');
    $(this).addClass('active');
    openIntegrationModal(target);
});
$('#config-editor').on('input', updateLineCount);
$(document).on('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveConfig();
    }
});
$('#config-editor').on('keydown', function(e) {
    if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const value = this.value;
        this.value = value.substring(0, start) + '  ' + value.substring(end);
        this.selectionStart = this.selectionEnd = start + 2;
    }
});
loadConfig();
loadIntegrationSettings();

// ==================== App Layer Configuration ====================
let appLayerProtocols = {};

function openAppLayerModal() {
    $('#app-layer-error').addClass('d-none').text('');
    $('#app-layer-success').addClass('d-none').text('');
    loadAppLayerConfig();
    $('#appLayerModal').modal('show');
}

function loadAppLayerConfig() {
    $('#app-layer-protocols-container').html('<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading protocols...</p>');

    $.get('/api/suricata-config/app-layer', function(data) {
        if (data.success) {
            appLayerProtocols = data.protocols || {};

            // Show warning if using defaults
            if (data.warning) {
                $('#app-layer-protocols-container').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ' + data.warning + '</div>');
                setTimeout(function() {
                    renderAppLayerProtocols(appLayerProtocols);
                }, 1000);
            } else {
                renderAppLayerProtocols(appLayerProtocols);
            }
        } else {
            $('#app-layer-protocols-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Failed to load protocols: ' + data.message + '</div>');
        }
    }).fail(function(xhr) {
        const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to connect to API';
        $('#app-layer-protocols-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + message + '</div>');
    });
}

function renderAppLayerProtocols(protocols) {
    let html = '<div class="row">';

    // Common protocols list
    const commonProtocols = ['http', 'tls', 'ssh', 'smtp', 'dns', 'ftp', 'smb', 'dcerpc', 'dhcp', 'nfs', 'tftp', 'ikev2', 'krb5', 'ntp', 'snmp', 'sip', 'rdp', 'rfb', 'mqtt', 'modbus'];

    commonProtocols.forEach(function(protocol) {
        const config = protocols[protocol] || {};
        const enabled = config.enabled === 'yes' || config.enabled === true;

        html += '<div class="col-md-6 mb-3">';
        html += '  <div class="card">';
        html += '    <div class="card-body py-2">';
        html += '      <div class="form-check form-switch">';
        html += '        <input class="form-check-input protocol-toggle" type="checkbox" id="protocol-' + protocol + '" data-protocol="' + protocol + '"' + (enabled ? ' checked' : '') + '>';
        html += '        <label class="form-check-label" for="protocol-' + protocol + '">';
        html += '          <strong>' + protocol.toUpperCase() + '</strong>';
        html += '        </label>';
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
    });

    html += '</div>';

    $('#app-layer-protocols-container').html(html);
}

function saveAppLayerConfig() {
    const $btn = $('#save-app-layer-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

    $('#app-layer-error').addClass('d-none').text('');
    $('#app-layer-success').addClass('d-none').text('');

    // Collect protocol states
    const protocols = {};
    $('.protocol-toggle').each(function() {
        const protocol = $(this).data('protocol');
        const enabled = $(this).is(':checked');
        protocols[protocol] = { enabled: enabled };
    });

    $.ajax({
        url: '/api/suricata-config/app-layer',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ protocols: protocols }),
        success: function(data) {
            if (data.success) {
                $('#app-layer-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#appLayerModal').modal('hide');
                }, 1500);
            } else {
                $('#app-layer-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#app-layer-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-app-layer-btn').click(saveAppLayerConfig);

// ==================== Outputs Configuration ====================
let outputsConfig = {};

function openOutputsModal() {
    $('#outputs-error').addClass('d-none').text('');
    $('#outputs-success').addClass('d-none').text('');
    loadOutputsConfig();
    $('#outputsModal').modal('show');
}

function loadOutputsConfig() {
    $('#outputs-container').html('<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading outputs...</p>');

    $.get('/api/suricata-config/outputs', function(data) {
        if (data.success) {
            outputsConfig = data.outputs || {};

            // Show warning if using defaults
            if (data.warning) {
                $('#outputs-container').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ' + data.warning + '</div>');
                setTimeout(function() {
                    renderOutputs(outputsConfig);
                }, 1000);
            } else {
                renderOutputs(outputsConfig);
            }
        } else {
            $('#outputs-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Failed to load outputs: ' + data.message + '</div>');
        }
    }).fail(function(xhr) {
        const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to connect to API';
        $('#outputs-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + message + '</div>');
    });
}

function renderOutputs(outputs) {
    let html = '<div class="row">';

    // Common outputs with descriptions
    const outputDefs = {
        'eve-log': {
            name: 'EVE JSON Log',
            description: 'Main event log in JSON format',
            icon: 'file-alt'
        },
        'fast': {
            name: 'Fast Alert Log',
            description: 'Simple one-line alert format',
            icon: 'bolt'
        },
        'stats': {
            name: 'Statistics Log',
            description: 'Performance and traffic statistics',
            icon: 'chart-bar'
        },
        'unified2-alert': {
            name: 'Unified2 Alert',
            description: 'Legacy alert format',
            icon: 'database'
        },
        'http-log': {
            name: 'HTTP Log',
            description: 'Dedicated HTTP transaction log',
            icon: 'globe'
        },
        'tls-log': {
            name: 'TLS Log',
            description: 'TLS/SSL handshake details',
            icon: 'lock'
        },
        'dns-log': {
            name: 'DNS Log',
            description: 'DNS queries and responses',
            icon: 'network-wired'
        },
        'pcap-log': {
            name: 'PCAP Log',
            description: 'Full packet capture',
            icon: 'save'
        }
    };

    Object.keys(outputDefs).forEach(function(outputKey) {
        const def = outputDefs[outputKey];
        const config = outputs[outputKey] || {};
        const enabled = config.enabled === 'yes' || config.enabled === true;

        html += '<div class="col-md-6 mb-3">';
        html += '  <div class="card' + (enabled ? ' border-success' : '') + '">';
        html += '    <div class="card-body">';
        html += '      <div class="form-check form-switch">';
        html += '        <input class="form-check-input output-toggle" type="checkbox" id="output-' + outputKey + '" data-output="' + outputKey + '"' + (enabled ? ' checked' : '') + '>';
        html += '        <label class="form-check-label" for="output-' + outputKey + '">';
        html += '          <i class="fas fa-' + def.icon + ' me-2"></i>';
        html += '          <strong>' + def.name + '</strong>';
        html += '        </label>';
        html += '      </div>';
        html += '      <small class="text-muted">' + def.description + '</small>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
    });

    html += '</div>';

    $('#outputs-container').html(html);
}

function saveOutputsConfig() {
    const $btn = $('#save-outputs-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

    $('#outputs-error').addClass('d-none').text('');
    $('#outputs-success').addClass('d-none').text('');

    // Collect output states
    const outputs = {};
    $('.output-toggle').each(function() {
        const outputName = $(this).data('output');
        const enabled = $(this).is(':checked');
        outputs[outputName] = { enabled: enabled };
    });

    $.ajax({
        url: '/api/suricata-config/outputs',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ outputs: outputs }),
        success: function(data) {
            if (data.success) {
                $('#outputs-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#outputsModal').modal('hide');
                }, 1500);
            } else {
                $('#outputs-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#outputs-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-outputs-btn').click(saveOutputsConfig);

// Logging Modal Functions
function openLoggingModal() {
    $('#loggingModal').modal('show');
    loadLoggingConfig();
}

function loadLoggingConfig() {
    $('#logging-error').addClass('d-none');
    $('#logging-success').addClass('d-none');
    $('#logging-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading logging configuration...</p></div>');

    $.ajax({
        url: '/api/suricata-config/logging',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#logging-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                }
                renderLogging(data.config);
            } else {
                $('#logging-error').removeClass('d-none').text(data.message || 'Failed to load logging configuration');
                $('#logging-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load logging configuration';
            $('#logging-error').removeClass('d-none').text(message);
            $('#logging-container').html('');
        }
    });
}

function renderLogging(config) {
    let html = '<div class="row">';

    // Default log level
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-level-up-alt"></i> Default Log Level</label>';
    html += '<select class="form-select" id="logging-default-level">';
    const levels = ['error', 'warning', 'notice', 'info', 'debug'];
    const currentLevel = config['default-log-level'] || 'notice';
    levels.forEach(function(level) {
        const selected = level === currentLevel ? ' selected' : '';
        html += '<option value="' + level + '"' + selected + '>' + level.toUpperCase() + '</option>';
    });
    html += '</select>';
    html += '</div>';

    // Default log format
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-file-code"></i> Default Log Format</label>';
    html += '<input type="text" class="form-control" id="logging-default-format" value="' + (config['default-log-format'] || '[%i] %t - (%f:%l) <%d> (%n) -- %m') + '">';
    html += '</div>';

    html += '</div>';

    // Outputs section
    html += '<h6 class="mt-3 mb-3"><i class="fas fa-terminal"></i> Logging Outputs</h6>';
    html += '<div class="row">';

    const outputs = config.outputs || [];
    const outputTypes = ['console', 'file', 'syslog'];

    outputTypes.forEach(function(outputType) {
        let outputConfig = null;
        outputs.forEach(function(out) {
            if (out[outputType]) {
                outputConfig = out[outputType];
            }
        });

        const enabled = outputConfig && (outputConfig.enabled === 'yes' || outputConfig.enabled === true);

        html += '<div class="col-md-4 mb-3">';
        html += '<div class="card h-100">';
        html += '<div class="card-body">';
        html += '<h6 class="card-title">';
        html += '<div class="form-check form-switch">';
        html += '<input class="form-check-input logging-output-toggle" type="checkbox" data-output="' + outputType + '"' + (enabled ? ' checked' : '') + '>';
        html += '<label class="form-check-label text-capitalize"><strong>' + outputType + '</strong></label>';
        html += '</div>';
        html += '</h6>';

        // Output-specific settings
        if (outputType === 'file') {
            const filename = (outputConfig && outputConfig.filename) || '/var/log/suricata/suricata.log';
            html += '<div class="mt-2"><label class="form-label small">Filename</label>';
            html += '<input type="text" class="form-control form-control-sm" id="logging-file-filename" value="' + filename + '"></div>';
        } else if (outputType === 'syslog') {
            const facility = (outputConfig && outputConfig.facility) || 'local5';
            html += '<div class="mt-2"><label class="form-label small">Facility</label>';
            html += '<input type="text" class="form-control form-control-sm" id="logging-syslog-facility" value="' + facility + '"></div>';
        }

        html += '</div></div></div>';
    });

    html += '</div>';

    $('#logging-container').html(html);
}

function saveLoggingConfig() {
    $('#logging-error').addClass('d-none');
    $('#logging-success').addClass('d-none');

    const $btn = $('#save-logging-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const config = {
        'default-log-level': $('#logging-default-level').val(),
        'default-log-format': $('#logging-default-format').val(),
        outputs: []
    };

    $('.logging-output-toggle').each(function() {
        const $toggle = $(this);
        const outputType = $toggle.data('output');
        const enabled = $toggle.is(':checked');

        let outputConfig = {
            enabled: enabled ? 'yes' : 'no'
        };

        if (outputType === 'file') {
            outputConfig.filename = $('#logging-file-filename').val();
        } else if (outputType === 'syslog') {
            outputConfig.facility = $('#logging-syslog-facility').val();
        }

        const output = {};
        output[outputType] = outputConfig;
        config.outputs.push(output);
    });

    $.ajax({
        url: '/api/suricata-config/logging',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(config),
        success: function(data) {
            if (data.success) {
                $('#logging-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#loggingModal').modal('hide');
                }, 1500);
            } else {
                $('#logging-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#logging-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-logging-btn').click(saveLoggingConfig);

// Detection Modal Functions
function openDetectionModal() {
    $('#detectionModal').modal('show');
    loadDetectionConfig();
}

function loadDetectionConfig() {
    $('#detection-error').addClass('d-none');
    $('#detection-success').addClass('d-none');
    $('#detection-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading detection configuration...</p></div>');

    $.ajax({
        url: '/api/suricata-config/detection',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#detection-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                }
                renderDetection(data.config);
            } else {
                $('#detection-error').removeClass('d-none').text(data.message || 'Failed to load detection configuration');
                $('#detection-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load detection configuration';
            $('#detection-error').removeClass('d-none').text(message);
            $('#detection-container').html('');
        }
    });
}

function renderDetection(config) {
    let html = '<div class="row">';

    // Detection profile
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-shield-alt"></i> Detection Profile</label>';
    html += '<select class="form-select" id="detection-profile">';
    const profiles = ['low', 'medium', 'high', 'custom'];
    const currentProfile = (config.detect && config.detect.profile) || 'medium';
    profiles.forEach(function(profile) {
        const selected = profile === currentProfile ? ' selected' : '';
        html += '<option value="' + profile + '"' + selected + '>' + profile.toUpperCase() + '</option>';
    });
    html += '</select>';
    html += '<small class="text-muted">Detection profile determines inspection depth</small>';
    html += '</div>';

    // MPM Algorithm
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-search"></i> Pattern Matching Algorithm</label>';
    html += '<select class="form-select" id="detection-mpm-algo">';
    const algos = ['auto', 'ac', 'ac-bs', 'hs'];
    const currentAlgo = config['mpm-algo'] || 'auto';
    algos.forEach(function(algo) {
        const selected = algo === currentAlgo ? ' selected' : '';
        html += '<option value="' + algo + '"' + selected + '>' + algo.toUpperCase() + '</option>';
    });
    html += '</select>';
    html += '<small class="text-muted">Pattern matching algorithm (auto recommended)</small>';
    html += '</div>';

    html += '</div>';

    // Threading section
    if (config.threading) {
        html += '<h6 class="mt-3 mb-3"><i class="fas fa-microchip"></i> Threading Configuration</h6>';
        html += '<div class="row">';

        html += '<div class="col-md-6 mb-3">';
        html += '<label class="form-label">Detect Threads</label>';
        html += '<input type="number" class="form-control" id="detection-detect-threads" value="' + (config.threading['detect-thread-ratio'] || 1.5) + '" step="0.5" min="0.5">';
        html += '<small class="text-muted">Detection thread ratio (multiplier of CPU cores)</small>';
        html += '</div>';

        html += '</div>';
    }

    // Profiling section
    html += '<h6 class="mt-3 mb-3"><i class="fas fa-chart-line"></i> Profiling</h6>';
    html += '<div class="row">';

    const profilingEnabled = config.profiling && (config.profiling.rules && config.profiling.rules.enabled === 'yes');
    html += '<div class="col-md-12 mb-3">';
    html += '<div class="form-check form-switch">';
    html += '<input class="form-check-input" type="checkbox" id="detection-profiling-enabled"' + (profilingEnabled ? ' checked' : '') + '>';
    html += '<label class="form-check-label">Enable Rule Profiling</label>';
    html += '</div>';
    html += '<small class="text-muted">Profile rule performance (may impact performance)</small>';
    html += '</div>';

    html += '</div>';

    $('#detection-container').html(html);
}

function saveDetectionConfig() {
    $('#detection-error').addClass('d-none');
    $('#detection-success').addClass('d-none');

    const $btn = $('#save-detection-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const config = {
        detect: {
            profile: $('#detection-profile').val()
        },
        'mpm-algo': $('#detection-mpm-algo').val(),
        threading: {
            'detect-thread-ratio': parseFloat($('#detection-detect-threads').val())
        },
        profiling: {
            rules: {
                enabled: $('#detection-profiling-enabled').is(':checked') ? 'yes' : 'no',
                filename: 'rule_perf.log',
                append: 'yes'
            }
        }
    };

    $.ajax({
        url: '/api/suricata-config/detection',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(config),
        success: function(data) {
            if (data.success) {
                $('#detection-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#detectionModal').modal('hide');
                }, 1500);
            } else {
                $('#detection-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#detection-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-detection-btn').click(saveDetectionConfig);
</script>
{% endblock %}




