{% extends "base.html" %}
{% block title %}Configuration - Suricata Dashboard{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Suricata Configuration</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Configure Suricata settings through an intuitive interface. Click on any section below to modify its configuration.
                </div>

                <!-- Suricata Config Cards -->
                <h6 class="text-uppercase fw-bold text-muted mb-3"><i class="fas fa-cog"></i> Suricata Configuration</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card h-100 border-secondary hover-shadow config-card" data-search="packet-capture" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-network-wired fa-3x text-secondary mb-3"></i>
                                <h5 class="card-title">Packet Capture</h5>
                                <p class="card-text text-muted small">Configure packet capture methods: AF-Packet, AF-XDP, DPDK, PCAP</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-primary hover-shadow config-card" data-search="app-layer" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">App Layer</h5>
                                <p class="card-text text-muted small">Enable/disable application layer protocols</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-success hover-shadow config-card" data-search="outputs" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-file-export fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Outputs</h5>
                                <p class="card-text text-muted small">Configure logging outputs and event formats</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-warning hover-shadow config-card" data-search="logging" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-clipboard-list fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">Logging</h5>
                                <p class="card-text text-muted small">Configure log levels and destinations</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-success hover-shadow config-card" data-search="vars" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Variables</h5>
                                <p class="card-text text-muted small">Manage address and port variables</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-info hover-shadow config-card" data-search="detection" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-3x text-info mb-3"></i>
                                <h5 class="card-title">IDS / Detection</h5>
                                <p class="card-text text-muted small">Configure detection engine and profiling</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-primary hover-shadow config-card" data-search="stream" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-stream fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Stream</h5>
                                <p class="card-text text-muted small">Configure stream engine and reassembly</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-dark hover-shadow config-card" data-search="host" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-server fa-3x text-dark mb-3"></i>
                                <h5 class="card-title">Host</h5>
                                <p class="card-text text-muted small">Configure host table and tracking settings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-danger hover-shadow config-card" data-search="ips" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                                <h5 class="card-title">IPS / Preventive</h5>
                                <p class="card-text text-muted small">Configure inline mode and prevention actions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-info hover-shadow config-card" data-search="interface" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-ethernet fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Interface</h5>
                                <p class="card-text text-muted small">Configure network interfaces and monitoring</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integration Cards -->
                <h6 class="text-uppercase fw-bold text-muted mb-3 mt-4"><i class="fas fa-plug"></i> Integrations</h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card h-100 border-primary hover-shadow integration-card" data-integration="discord" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fab fa-discord fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Discord</h5>
                                <p class="card-text text-muted small">Configure Discord webhook notifications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-info hover-shadow integration-card" data-integration="telegram" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fab fa-telegram fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Telegram</h5>
                                <p class="card-text text-muted small">Configure Telegram bot notifications</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
</style>
<div class="modal fade" id="integrationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="integrationModalLabel">Integration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="integration-error"></div>
                <div class="alert alert-success d-none" id="integration-success"></div>
                <div class="text-muted small d-none" id="integration-hash-wrapper">
                    MD5 Hash: <code id="integration-hash-value">-</code>
                </div>
                <input type="hidden" id="integration-name">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="integration-enabled">
                    <label class="form-check-label" for="integration-enabled">Enable integration</label>
                </div>
                <div id="discord-fields" class="integration-fields d-none">
                    <div class="mb-3">
                        <label for="discord-webhook" class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="discord-webhook" placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">Provide a Discord webhook URL with notification permissions.</div>
                    </div>
                    <div class="mb-3">
                        <label for="discord-template" class="form-label">Custom Message Template (Optional)</label>
                        <textarea class="form-control font-monospace" id="discord-template" rows="6" placeholder="Ã°Å¸Å¡Â¨ Security Alert&#10;&#10;Signature: {signature}&#10;Category: {category}&#10;Severity: {severity}&#10;Source: {src_ip}:{src_port}&#10;Destination: {dest_ip}:{dest_port}&#10;Protocol: {protocol}"></textarea>
                        <div class="form-text">
                            Available variables: {signature}, {category}, {severity}, {src_ip}, {src_port}, {dest_ip}, {dest_port}, {protocol}, {timestamp}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate Limiting</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="discord-rate-limit-messages" class="form-label small">Max Messages</label>
                                <input type="number" class="form-control form-control-sm" id="discord-rate-limit-messages" value="30" min="1" max="100">
                                <div class="form-text">Maximum messages allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="discord-rate-limit-interval" class="form-label small">Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="discord-rate-limit-interval" value="60" min="10" max="3600">
                                <div class="form-text">Time window in seconds</div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Default: 30 messages per 60 seconds
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-info" id="discord-test-btn">
                            <i class="fas fa-paper-plane"></i> Test Send Message
                        </button>
                    </div>
                </div>
                <div id="telegram-fields" class="integration-fields d-none">
                    <div class="mb-3">
                        <label for="telegram-bot-token" class="form-label">Bot Token</label>
                        <input type="text" class="form-control" id="telegram-bot-token" placeholder="123456789:ABCDEF...">
                    </div>
                    <div class="mb-3">
                        <label for="telegram-chat-id" class="form-label">Chat ID</label>
                        <input type="text" class="form-control" id="telegram-chat-id" placeholder="@channel or numeric chat id">
                        <div class="form-text">Use the numeric chat ID or channel handle for the target destination.</div>
                    </div>
                    <div class="mb-3">
                        <label for="telegram-template" class="form-label">Custom Message Template (Optional)</label>
                        <textarea class="form-control font-monospace" id="telegram-template" rows="6" placeholder="Ã°Å¸Å¡Â¨ Security Alert&#10;&#10;Signature: {signature}&#10;Category: {category}&#10;Severity: {severity}&#10;Source: {src_ip}:{src_port}&#10;Destination: {dest_ip}:{dest_port}&#10;Protocol: {protocol}"></textarea>
                        <div class="form-text">
                            Available variables: {signature}, {category}, {severity}, {src_ip}, {src_port}, {dest_ip}, {dest_port}, {protocol}, {timestamp}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate Limiting</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="telegram-rate-limit-messages" class="form-label small">Max Messages</label>
                                <input type="number" class="form-control form-control-sm" id="telegram-rate-limit-messages" value="20" min="1" max="100">
                                <div class="form-text">Maximum messages allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="telegram-rate-limit-interval" class="form-label small">Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="telegram-rate-limit-interval" value="60" min="10" max="3600">
                                <div class="form-text">Time window in seconds</div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Default: 20 messages per 60 seconds
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-info" id="telegram-test-btn">
                            <i class="fas fa-paper-plane"></i> Test Send Message
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="integration-save-btn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuration Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="config-modal-message">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- App Layer Config Modal -->
<div class="modal fade" id="appLayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> App Layer Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Enable/disable application layer protocols for deep packet inspection.
                </div>
                <div class="alert alert-danger d-none" id="app-layer-error"></div>
                <div class="alert alert-success d-none" id="app-layer-success"></div>

                <div id="app-layer-protocols-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading protocols...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-app-layer-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Outputs Config Modal -->
<div class="modal fade" id="outputsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-export"></i> Outputs Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure logging outputs for Suricata events and alerts.
                </div>
                <div class="alert alert-danger d-none" id="outputs-error"></div>
                <div class="alert alert-success d-none" id="outputs-success"></div>

                <div id="outputs-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading outputs...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="save-outputs-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Logging Modal -->
<div class="modal fade" id="loggingModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> Logging Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure Suricata logging system and output destinations.
                </div>
                <div class="alert alert-danger d-none" id="logging-error"></div>
                <div class="alert alert-success d-none" id="logging-success"></div>

                <div id="logging-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading logging configuration...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="save-logging-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detection Modal -->
<div class="modal fade" id="detectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-search"></i> Detection Engine Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure detection engine settings including profile, threading, and performance tuning.
                </div>
                <div class="alert alert-danger d-none" id="detection-error"></div>
                <div class="alert alert-success d-none" id="detection-success"></div>

                <div id="detection-container">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading detection configuration...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="save-detection-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>




<!-- Packet Capture Modal -->

<div class="modal fade" id="packetCaptureModal" tabindex="-1">

    <div class="modal-dialog modal-xl modal-dialog-scrollable">

        <div class="modal-content">

            <div class="modal-header bg-secondary text-white">

                <h5 class="modal-title"><i class="fas fa-network-wired"></i> Packet Capture Configuration</h5>

                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>

            </div>

            <div class="modal-body">

                <div class="alert alert-info">

                    <i class="fas fa-info-circle"></i> Configure packet capture methods: AF-Packet, AF-XDP, DPDK, or PCAP.

                </div>

                <div class="alert alert-danger d-none" id="packet-capture-error"></div>

                <div class="alert alert-success d-none" id="packet-capture-success"></div>

                <!-- Capture Type Selector -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Capture Method</label>
                    <select class="form-select" id="capture-type-selector">
                        <option value="af-packet">AF-Packet (Linux Native)</option>
                        <option value="af-xdp">AF-XDP (Express Data Path)</option>
                        <option value="dpdk">DPDK (Data Plane Development Kit)</option>
                        <option value="pcap">PCAP (Packet Capture)</option>
                    </select>
                    <small class="text-muted">Select the packet capture method to configure</small>
                </div>

                <div id="packet-capture-container">

                    <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading packet capture configuration...</p>

                </div>

            </div>

            <div class="modal-footer">

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                <button type="button" class="btn btn-secondary" id="save-packet-capture-btn">

                    <i class="fas fa-save"></i> Save Configuration

                </button>

            </div>

        </div>

    </div>

</div>



<!-- Stream Modal -->

<div class="modal fade" id="streamModal" tabindex="-1">

    <div class="modal-dialog modal-lg modal-dialog-scrollable">

        <div class="modal-content">

            <div class="modal-header bg-primary text-white">

                <h5 class="modal-title"><i class="fas fa-stream"></i> Stream Configuration</h5>

                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>

            </div>

            <div class="modal-body">

                <div class="alert alert-info">

                    <i class="fas fa-info-circle"></i> Configure stream engine memory, checksum validation, and reassembly behaviour.

                </div>

                <div class="alert alert-danger d-none" id="stream-error"></div>

                <div class="alert alert-success d-none" id="stream-success"></div>



                <div id="stream-container">

                    <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading stream configuration...</p>

                </div>

            </div>

            <div class="modal-footer">

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                <button type="button" class="btn btn-primary" id="save-stream-btn">

                    <i class="fas fa-save"></i> Save Configuration

                </button>

            </div>

        </div>

    </div>

</div>



<!-- Host Modal -->
<div class="modal fade" id="hostModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-server"></i> Host Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure host table settings for tracking IP addresses and their attributes.
                </div>
                <div class="alert alert-danger d-none" id="host-error"></div>
                <div class="alert alert-success d-none" id="host-success"></div>

                <div id="host-container">
                    <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading host configuration...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dark" id="save-host-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- IPS/Preventive Modal -->
<div class="modal fade" id="ipsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-shield-alt"></i> IPS / Preventive Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> IPS mode actively blocks traffic. Ensure proper testing before enabling in production.
                </div>
                <div class="alert alert-danger d-none" id="ips-error"></div>
                <div class="alert alert-success d-none" id="ips-success"></div>

                <div id="ips-container">
                    <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading IPS configuration...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="save-ips-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Interface Modal -->
<div class="modal fade" id="interfaceModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-ethernet"></i> Interface Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Configure network interfaces for Suricata monitoring. Interfaces are auto-detected from your system.
                </div>
                <div class="alert alert-danger d-none" id="interface-error"></div>
                <div class="alert alert-success d-none" id="interface-success"></div>

                <div id="interface-container">
                    <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading interfaces...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="save-interface-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Variables Modal -->

<div class="modal fade" id="varsModal" tabindex="-1">

    <div class="modal-dialog modal-lg modal-dialog-scrollable">

        <div class="modal-content">

            <div class="modal-header bg-success text-white">

                <h5 class="modal-title"><i class="fas fa-dollar-sign"></i> Variables Configuration</h5>

                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>

            </div>

            <div class="modal-body">

                <div class="alert alert-info">

                    <i class="fas fa-info-circle"></i> Manage Suricata address and port variables. Use JSON mode for structured values such as groups or lists.

                </div>

                <div class="alert alert-danger d-none" id="vars-error"></div>

                <div class="alert alert-success d-none" id="vars-success"></div>



                <div id="vars-container">

                    <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading variables...</p>

                </div>

            </div>

            <div class="modal-footer">

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                <button type="button" class="btn btn-success" id="save-vars-btn">

                    <i class="fas fa-save"></i> Save Configuration

                </button>

            </div>

        </div>

    </div>

</div>

{% endblock %}
{% block scripts %}
<script>
const integrationDefaults = {
    discord: {
        enabled: false,
        webhook_url: '',
        message_template: '',
        rate_limit_messages: 30,
        rate_limit_interval: 60
    },
    telegram: {
        enabled: false,
        bot_token: '',
        chat_id: '',
        message_template: '',
        rate_limit_messages: 20,
        rate_limit_interval: 60
    }
};
let integrationSettings = {};
let integrationHashes = {};
let integrationModalInstance = null;
let afPacketConfig = {};
let streamConfig = {};
let varsConfig = {};

function escapeHtml(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function toBoolean(value, fallback = false) {
    if (value === null || value === undefined) {
        return fallback;
    }
    if (typeof value === 'boolean') {
        return value;
    }
    const normalized = String(value).toLowerCase();
    if (['yes', 'true', '1'].includes(normalized)) {
        return true;
    }
    if (['no', 'false', '0'].includes(normalized)) {
        return false;
    }
    return fallback;
}
function loadIntegrationSettings() {
    $.get('/api/integration', function(response) {
        if (response.success && response.settings) {
            integrationSettings = response.settings;
            integrationHashes = response.hashes || {};
        }
    }).fail(function(xhr) {
        console.warn('Failed to load integration settings', xhr.responseText || xhr.statusText);
    });
}
function getIntegrationData(name) {
    const defaults = integrationDefaults[name] || {};
    const stored = integrationSettings[name] || {};
    return Object.assign({}, defaults, stored);
}
function resetIntegrationFeedback() {
    $('#integration-error').addClass('d-none').text('');
    $('#integration-success').addClass('d-none').text('');
}
function hideIntegrationHash() {
    $('#integration-hash-wrapper').addClass('d-none');
    $('#integration-hash-value').text('-');
}

function updateIntegrationHashDisplay(info) {
    if (info && info.config_hash) {
        $('#integration-hash-wrapper').removeClass('d-none');
        $('#integration-hash-value').text(info.config_hash);
    } else {
        hideIntegrationHash();
    }
}
function setIntegrationFeedback(message, type) {
    if (!message) {
        resetIntegrationFeedback();
        return;
    }
    if (type === 'success') {
        $('#integration-success').removeClass('d-none').text(message);
        $('#integration-error').addClass('d-none').text('');
    } else {
        $('#integration-error').removeClass('d-none').text(message);
        $('#integration-success').addClass('d-none').text('');
    }
}
function toggleIntegrationFields(name) {
    $('.integration-fields').addClass('d-none');
    if (name === 'discord') {
        $('#discord-fields').removeClass('d-none');
    } else if (name === 'telegram') {
        $('#telegram-fields').removeClass('d-none');
    }
}
function openIntegrationModal(name) {
    const normalized = (name || '').toLowerCase();
    const data = getIntegrationData(normalized);
    if (!integrationModalInstance) {
        integrationModalInstance = new bootstrap.Modal(document.getElementById('integrationModal'));
    }
    $('#integration-name').val(normalized);
    $('#integrationModalLabel').text(normalized === 'telegram' ? 'Telegram Integration' : 'Discord Integration');
    $('#integration-enabled').prop('checked', !!data.enabled);
    $('#discord-webhook').val(data.webhook_url || '');
    $('#discord-template').val(data.message_template || '');
    $('#discord-rate-limit-messages').val(data.rate_limit_messages || 30);
    $('#discord-rate-limit-interval').val(data.rate_limit_interval || 60);
    $('#telegram-bot-token').val(data.bot_token || '');
    $('#telegram-chat-id').val(data.chat_id || '');
    $('#telegram-template').val(data.message_template || '');
    $('#telegram-rate-limit-messages').val(data.rate_limit_messages || 20);
    $('#telegram-rate-limit-interval').val(data.rate_limit_interval || 60);
    updateIntegrationHashDisplay(integrationHashes[normalized]);
    toggleIntegrationFields(normalized);
    resetIntegrationFeedback();
    integrationModalInstance.show();
}
function collectIntegrationPayload(name) {
    const normalized = (name || '').toLowerCase();
    const payload = { enabled: $('#integration-enabled').is(':checked') };
    if (normalized === 'discord') {
        payload.webhook_url = ($('#discord-webhook').val() || '').trim();
        payload.message_template = ($('#discord-template').val() || '').trim();
        payload.rate_limit_messages = parseInt($('#discord-rate-limit-messages').val() || 30);
        payload.rate_limit_interval = parseInt($('#discord-rate-limit-interval').val() || 60);
    } else if (normalized === 'telegram') {
        payload.bot_token = ($('#telegram-bot-token').val() || '').trim();
        payload.chat_id = ($('#telegram-chat-id').val() || '').trim();
        payload.message_template = ($('#telegram-template').val() || '').trim();
        payload.rate_limit_messages = parseInt($('#telegram-rate-limit-messages').val() || 20);
        payload.rate_limit_interval = parseInt($('#telegram-rate-limit-interval').val() || 60);
    }
    return payload;
}
function setIntegrationSaving(isSaving) {
    const $btn = $('#integration-save-btn');
    if (isSaving) {
        if (!$btn.data('original-html')) {
            $btn.data('original-html', $btn.html());
        }
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');
    } else {
        const original = $btn.data('original-html');
        if (original) {
            $btn.html(original);
        }
        $btn.prop('disabled', false);
    }
}
function saveIntegration() {
    const name = $('#integration-name').val();
    if (!name) {
        return;
    }
    const payload = collectIntegrationPayload(name);
    setIntegrationSaving(true);
    resetIntegrationFeedback();
    $.ajax({
        url: '/api/integration/' + name,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
            if (response.success) {
                integrationSettings[name] = response.settings || payload;
                if (response.hash) {
                    integrationHashes[name] = response.hash;
                    updateIntegrationHashDisplay(response.hash);
                } else if (integrationHashes[name]) {
                    updateIntegrationHashDisplay(integrationHashes[name]);
                } else {
                    hideIntegrationHash();
                }
                setIntegrationFeedback('Settings saved successfully.', 'success');
            } else {
                setIntegrationFeedback(response.message || 'Failed to save settings.', 'error');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || xhr.responseText || 'Failed to save settings.';
            setIntegrationFeedback(message, 'error');
        },
        complete: function() {
            setIntegrationSaving(false);
        }
    });
}
$('#integration-save-btn').click(saveIntegration);
$('#integrationModal').on('hidden.bs.modal', function() {
    $('#integration-name').val('');
    $('#integration-enabled').prop('checked', false);
    $('#discord-webhook, #discord-template, #telegram-bot-token, #telegram-chat-id, #telegram-template').val('');
    $('#discord-rate-limit-messages').val(30);
    $('#discord-rate-limit-interval').val(60);
    $('#telegram-rate-limit-messages').val(20);
    $('#telegram-rate-limit-interval').val(60);
    hideIntegrationHash();
    resetIntegrationFeedback();
    setIntegrationSaving(false);
});

// Test send message functions
function testSendMessage(integration) {
    const name = integration.toLowerCase();
    let payload = {};

    if (name === 'telegram') {
        const bot_token = $('#telegram-bot-token').val().trim();
        const chat_id = $('#telegram-chat-id').val().trim();
        const template = $('#telegram-template').val().trim();

        if (!bot_token || !chat_id) {
            setIntegrationFeedback('Please fill in Bot Token and Chat ID first', 'error');
            return;
        }

        if (template) {
            payload.message = template;
        }
    } else if (name === 'discord') {
        const webhook_url = $('#discord-webhook').val().trim();
        const template = $('#discord-template').val().trim();

        if (!webhook_url) {
            setIntegrationFeedback('Please fill in Webhook URL first', 'error');
            return;
        }

        if (template) {
            payload.message = template;
        }
    }

    resetIntegrationFeedback();

    // Show loading state
    const btnId = '#' + name + '-test-btn';
    const $btn = $(btnId);
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Sending...');

    // First save the settings to ensure we test with current config
    const savePayload = collectIntegrationPayload(name);

    $.ajax({
        url: '/api/integration/' + name,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(savePayload),
        success: function(response) {
            // Now send test message
            $.ajax({
                url: '/api/integration/' + name + '/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(data) {
                    if (data.success) {
                        setIntegrationFeedback(data.message, 'success');
                    } else {
                        setIntegrationFeedback(data.message, 'error');
                    }
                },
                error: function(xhr) {
                    const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to send test message';
                    setIntegrationFeedback(message, 'error');
                },
                complete: function() {
                    $btn.prop('disabled', false).html(originalHtml);
                }
            });
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save settings';
            setIntegrationFeedback(message, 'error');
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#telegram-test-btn').click(function() {
    testSendMessage('telegram');
});

$('#discord-test-btn').click(function() {
    testSendMessage('discord');
});

// Card click handlers
$('.config-card').click(function() {
    const searchTerm = $(this).data('search');

    if (searchTerm === 'packet-capture') {
        openPacketCaptureModal();
    } else if (searchTerm === 'af-packet') {
        // Backward compatibility - redirect to packet capture
        openPacketCaptureModal('af-packet');
    } else if (searchTerm === 'app-layer') {
        openAppLayerModal();
    } else if (searchTerm === 'outputs') {
        openOutputsModal();
    } else if (searchTerm === 'logging') {
        openLoggingModal();
    } else if (searchTerm === 'vars') {
        openVarsModal();
    } else if (searchTerm === 'detection') {
        openDetectionModal();
    } else if (searchTerm === 'stream') {
        openStreamModal();
    } else if (searchTerm === 'host') {
        openHostModal();
    } else if (searchTerm === 'ips') {
        openIpsModal();
    } else if (searchTerm === 'interface') {
        openInterfaceModal();
    }
});

$('.integration-card').click(function() {
    const integration = $(this).data('integration');
    openIntegrationModal(integration);
});

loadIntegrationSettings();

// ==================== App Layer Configuration ====================
let appLayerProtocols = {};

function openAppLayerModal() {
    $('#app-layer-error').addClass('d-none').text('');
    $('#app-layer-success').addClass('d-none').text('');
    loadAppLayerConfig();
    $('#appLayerModal').modal('show');
}

function loadAppLayerConfig() {
    $('#app-layer-protocols-container').html('<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading protocols...</p>');

    $.get('/api/suricata-config/app-layer', function(data) {
        if (data.success) {
            appLayerProtocols = data.protocols || {};

            // Show warning if using defaults
            if (data.warning) {
                $('#app-layer-protocols-container').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ' + data.warning + '</div>');
                setTimeout(function() {
                    renderAppLayerProtocols(appLayerProtocols);
                }, 1000);
            } else {
                renderAppLayerProtocols(appLayerProtocols);
            }
        } else {
            $('#app-layer-protocols-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Failed to load protocols: ' + data.message + '</div>');
        }
    }).fail(function(xhr) {
        const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to connect to API';
        $('#app-layer-protocols-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + message + '</div>');
    });
}

function renderAppLayerProtocols(protocols) {
    let html = '<div class="row">';

    // Common protocols list
    const commonProtocols = ['http', 'tls', 'ssh', 'smtp', 'dns', 'ftp', 'smb', 'dcerpc', 'dhcp', 'nfs', 'tftp', 'ikev2', 'krb5', 'ntp', 'snmp', 'sip', 'rdp', 'rfb', 'mqtt', 'modbus'];

    commonProtocols.forEach(function(protocol) {
        const config = protocols[protocol] || {};
        const enabled = config.enabled === 'yes' || config.enabled === true;

        html += '<div class="col-md-6 mb-3">';
        html += '  <div class="card">';
        html += '    <div class="card-body py-2">';
        html += '      <div class="form-check form-switch">';
        html += '        <input class="form-check-input protocol-toggle" type="checkbox" id="protocol-' + protocol + '" data-protocol="' + protocol + '"' + (enabled ? ' checked' : '') + '>';
        html += '        <label class="form-check-label" for="protocol-' + protocol + '">';
        html += '          <strong>' + protocol.toUpperCase() + '</strong>';
        html += '        </label>';
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
    });

    html += '</div>';

    $('#app-layer-protocols-container').html(html);
}

function saveAppLayerConfig() {
    const $btn = $('#save-app-layer-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

    $('#app-layer-error').addClass('d-none').text('');
    $('#app-layer-success').addClass('d-none').text('');

    // Collect protocol states
    const protocols = {};
    $('.protocol-toggle').each(function() {
        const protocol = $(this).data('protocol');
        const enabled = $(this).is(':checked');
        protocols[protocol] = { enabled: enabled };
    });

    $.ajax({
        url: '/api/suricata-config/app-layer',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ protocols: protocols }),
        success: function(data) {
            if (data.success) {
                $('#app-layer-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#appLayerModal').modal('hide');
                }, 1500);
            } else {
                $('#app-layer-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#app-layer-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-app-layer-btn').click(saveAppLayerConfig);

// ==================== Outputs Configuration ====================
let outputsConfig = {};

function openOutputsModal() {
    $('#outputs-error').addClass('d-none').text('');
    $('#outputs-success').addClass('d-none').text('');
    loadOutputsConfig();
    $('#outputsModal').modal('show');
}

function loadOutputsConfig() {
    $('#outputs-container').html('<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading outputs...</p>');

    $.get('/api/suricata-config/outputs', function(data) {
        if (data.success) {
            outputsConfig = data.outputs || {};

            // Show warning if using defaults
            if (data.warning) {
                $('#outputs-container').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ' + data.warning + '</div>');
                setTimeout(function() {
                    renderOutputs(outputsConfig);
                }, 1000);
            } else {
                renderOutputs(outputsConfig);
            }
        } else {
            $('#outputs-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Failed to load outputs: ' + data.message + '</div>');
        }
    }).fail(function(xhr) {
        const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to connect to API';
        $('#outputs-container').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + message + '</div>');
    });
}

function renderOutputs(outputs) {
    let html = '<div class="row">';

    // Common outputs with descriptions
    const outputDefs = {
        'eve-log': {
            name: 'EVE JSON Log',
            description: 'Main event log in JSON format',
            icon: 'file-alt'
        },
        'fast': {
            name: 'Fast Alert Log',
            description: 'Simple one-line alert format',
            icon: 'bolt'
        },
        'stats': {
            name: 'Statistics Log',
            description: 'Performance and traffic statistics',
            icon: 'chart-bar'
        },
        'unified2-alert': {
            name: 'Unified2 Alert',
            description: 'Legacy alert format',
            icon: 'database'
        },
        'http-log': {
            name: 'HTTP Log',
            description: 'Dedicated HTTP transaction log',
            icon: 'globe'
        },
        'tls-log': {
            name: 'TLS Log',
            description: 'TLS/SSL handshake details',
            icon: 'lock'
        },
        'dns-log': {
            name: 'DNS Log',
            description: 'DNS queries and responses',
            icon: 'network-wired'
        },
        'pcap-log': {
            name: 'PCAP Log',
            description: 'Full packet capture',
            icon: 'save'
        }
    };

    Object.keys(outputDefs).forEach(function(outputKey) {
        const def = outputDefs[outputKey];
        const config = outputs[outputKey] || {};
        const enabled = config.enabled === 'yes' || config.enabled === true;

        html += '<div class="col-md-6 mb-3">';
        html += '  <div class="card' + (enabled ? ' border-success' : '') + '">';
        html += '    <div class="card-body">';
        html += '      <div class="form-check form-switch">';
        html += '        <input class="form-check-input output-toggle" type="checkbox" id="output-' + outputKey + '" data-output="' + outputKey + '"' + (enabled ? ' checked' : '') + '>';
        html += '        <label class="form-check-label" for="output-' + outputKey + '">';
        html += '          <i class="fas fa-' + def.icon + ' me-2"></i>';
        html += '          <strong>' + def.name + '</strong>';
        html += '        </label>';
        html += '      </div>';
        html += '      <small class="text-muted">' + def.description + '</small>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
    });

    html += '</div>';

    $('#outputs-container').html(html);
}

function saveOutputsConfig() {
    const $btn = $('#save-outputs-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

    $('#outputs-error').addClass('d-none').text('');
    $('#outputs-success').addClass('d-none').text('');

    // Collect output states
    const outputs = {};
    $('.output-toggle').each(function() {
        const outputName = $(this).data('output');
        const enabled = $(this).is(':checked');
        outputs[outputName] = { enabled: enabled };
    });

    $.ajax({
        url: '/api/suricata-config/outputs',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ outputs: outputs }),
        success: function(data) {
            if (data.success) {
                $('#outputs-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#outputsModal').modal('hide');
                }, 1500);
            } else {
                $('#outputs-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#outputs-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-outputs-btn').click(saveOutputsConfig);

// Logging Modal Functions
function openLoggingModal() {
    $('#loggingModal').modal('show');
    loadLoggingConfig();
}

function loadLoggingConfig() {
    $('#logging-error').addClass('d-none');
    $('#logging-success').addClass('d-none');
    $('#logging-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading logging configuration...</p></div>');

    $.ajax({
        url: '/api/suricata-config/logging',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#logging-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                }
                renderLogging(data.logging || data.config || {});
            } else {
                $('#logging-error').removeClass('d-none').text(data.message || 'Failed to load logging configuration');
                $('#logging-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load logging configuration';
            $('#logging-error').removeClass('d-none').text(message);
            $('#logging-container').html('');
        }
    });
}

function renderLogging(config) {
    let html = '<div class="row">';

    // Default log level
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-level-up-alt"></i> Default Log Level</label>';
    html += '<select class="form-select" id="logging-default-level">';
    const levels = ['error', 'warning', 'notice', 'info', 'debug'];
    const currentLevel = config['default-log-level'] || 'notice';
    levels.forEach(function(level) {
        const selected = level === currentLevel ? ' selected' : '';
        html += '<option value="' + level + '"' + selected + '>' + level.toUpperCase() + '</option>';
    });
    html += '</select>';
    html += '</div>';

    // Default log format
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-file-code"></i> Default Log Format</label>';
    html += '<input type="text" class="form-control" id="logging-default-format" value="' + (config['default-log-format'] || '[%i] %t - (%f:%l) <%d> (%n) -- %m') + '">';
    html += '</div>';

    html += '</div>';

    // Outputs section
    html += '<h6 class="mt-3 mb-3"><i class="fas fa-terminal"></i> Logging Outputs</h6>';
    html += '<div class="row">';

    const outputs = config.outputs || [];
    const outputTypes = ['console', 'file', 'syslog'];

    outputTypes.forEach(function(outputType) {
        let outputConfig = null;
        outputs.forEach(function(out) {
            if (out[outputType]) {
                outputConfig = out[outputType];
            }
        });

        const enabled = outputConfig && (outputConfig.enabled === 'yes' || outputConfig.enabled === true);

        html += '<div class="col-md-4 mb-3">';
        html += '<div class="card h-100">';
        html += '<div class="card-body">';
        html += '<h6 class="card-title">';
        html += '<div class="form-check form-switch">';
        html += '<input class="form-check-input logging-output-toggle" type="checkbox" data-output="' + outputType + '"' + (enabled ? ' checked' : '') + '>';
        html += '<label class="form-check-label text-capitalize"><strong>' + outputType + '</strong></label>';
        html += '</div>';
        html += '</h6>';

        // Output-specific settings
        if (outputType === 'file') {
            const filename = (outputConfig && outputConfig.filename) || '/var/log/suricata/suricata.log';
            html += '<div class="mt-2"><label class="form-label small">Filename</label>';
            html += '<input type="text" class="form-control form-control-sm" id="logging-file-filename" value="' + filename + '"></div>';
        } else if (outputType === 'syslog') {
            const facility = (outputConfig && outputConfig.facility) || 'local5';
            html += '<div class="mt-2"><label class="form-label small">Facility</label>';
            html += '<input type="text" class="form-control form-control-sm" id="logging-syslog-facility" value="' + facility + '"></div>';
        }

        html += '</div></div></div>';
    });

    html += '</div>';

    $('#logging-container').html(html);
}

function saveLoggingConfig() {
    $('#logging-error').addClass('d-none');
    $('#logging-success').addClass('d-none');

    const $btn = $('#save-logging-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const config = {
        'default-log-level': $('#logging-default-level').val(),
        'default-log-format': $('#logging-default-format').val(),
        outputs: []
    };

    $('.logging-output-toggle').each(function() {
        const $toggle = $(this);
        const outputType = $toggle.data('output');
        const enabled = $toggle.is(':checked');

        let outputConfig = {
            enabled: enabled ? 'yes' : 'no'
        };

        if (outputType === 'file') {
            outputConfig.filename = $('#logging-file-filename').val();
        } else if (outputType === 'syslog') {
            outputConfig.facility = $('#logging-syslog-facility').val();
        }

        const output = {};
        output[outputType] = outputConfig;
        config.outputs.push(output);
    });

    $.ajax({
        url: '/api/suricata-config/logging',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ logging: config }),
        success: function(data) {
            if (data.success) {
                $('#logging-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#loggingModal').modal('hide');
                }, 1500);
            } else {
                $('#logging-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#logging-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-logging-btn').click(saveLoggingConfig);

// Detection Modal Functions
function openDetectionModal() {
    $('#detectionModal').modal('show');
    loadDetectionConfig();
}

function loadDetectionConfig() {
    $('#detection-error').addClass('d-none');
    $('#detection-success').addClass('d-none');
    $('#detection-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading detection configuration...</p></div>');

    $.ajax({
        url: '/api/suricata-config/detection',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#detection-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                }
                renderDetection(data.detection || data.config || {});
            } else {
                $('#detection-error').removeClass('d-none').text(data.message || 'Failed to load detection configuration');
                $('#detection-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load detection configuration';
            $('#detection-error').removeClass('d-none').text(message);
            $('#detection-container').html('');
        }
    });
}

function renderDetection(config) {
    let html = '<div class="row">';

    // Detection profile
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-shield-alt"></i> Detection Profile</label>';
    html += '<select class="form-select" id="detection-profile">';
    const profiles = ['low', 'medium', 'high', 'custom'];
    const currentProfile = (config.detect && config.detect.profile) || 'medium';
    profiles.forEach(function(profile) {
        const selected = profile === currentProfile ? ' selected' : '';
        html += '<option value="' + profile + '"' + selected + '>' + profile.toUpperCase() + '</option>';
    });
    html += '</select>';
    html += '<small class="text-muted">Detection profile determines inspection depth</small>';
    html += '</div>';

    // MPM Algorithm
    html += '<div class="col-md-6 mb-3">';
    html += '<label class="form-label"><i class="fas fa-search"></i> Pattern Matching Algorithm</label>';
    html += '<select class="form-select" id="detection-mpm-algo">';
    const algos = ['auto', 'ac', 'ac-bs', 'hs'];
    const currentAlgo = config['mpm-algo'] || 'auto';
    algos.forEach(function(algo) {
        const selected = algo === currentAlgo ? ' selected' : '';
        html += '<option value="' + algo + '"' + selected + '>' + algo.toUpperCase() + '</option>';
    });
    html += '</select>';
    html += '<small class="text-muted">Pattern matching algorithm (auto recommended)</small>';
    html += '</div>';

    html += '</div>';

    // Threading section
    if (config.threading) {
        html += '<h6 class="mt-3 mb-3"><i class="fas fa-microchip"></i> Threading Configuration</h6>';
        html += '<div class="row">';

        html += '<div class="col-md-6 mb-3">';
        html += '<label class="form-label">Detect Threads</label>';
        html += '<input type="number" class="form-control" id="detection-detect-threads" value="' + (config.threading['detect-thread-ratio'] || 1.5) + '" step="0.5" min="0.5">';
        html += '<small class="text-muted">Detection thread ratio (multiplier of CPU cores)</small>';
        html += '</div>';

        html += '</div>';
    }

    // Profiling section
    html += '<h6 class="mt-3 mb-3"><i class="fas fa-chart-line"></i> Profiling</h6>';
    html += '<div class="row">';

    const profilingEnabled = config.profiling && (config.profiling.rules && config.profiling.rules.enabled === 'yes');
    html += '<div class="col-md-12 mb-3">';
    html += '<div class="form-check form-switch">';
    html += '<input class="form-check-input" type="checkbox" id="detection-profiling-enabled"' + (profilingEnabled ? ' checked' : '') + '>';
    html += '<label class="form-check-label">Enable Rule Profiling</label>';
    html += '</div>';
    html += '<small class="text-muted">Profile rule performance (may impact performance)</small>';
    html += '</div>';

    html += '</div>';

    $('#detection-container').html(html);
}

function saveDetectionConfig() {
    $('#detection-error').addClass('d-none');
    $('#detection-success').addClass('d-none');

    const $btn = $('#save-detection-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const config = {
        detect: {
            profile: $('#detection-profile').val()
        },
        'mpm-algo': $('#detection-mpm-algo').val(),
        threading: {
            'detect-thread-ratio': parseFloat($('#detection-detect-threads').val())
        },
        profiling: {
            rules: {
                enabled: $('#detection-profiling-enabled').is(':checked') ? 'yes' : 'no',
                filename: 'rule_perf.log',
                append: 'yes'
            }
        }
    };

    $.ajax({
        url: '/api/suricata-config/detection',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ detection: config }),
        success: function(data) {
            if (data.success) {
                $('#detection-success').removeClass('d-none').text(data.message);
                setTimeout(function() {
                    $('#detectionModal').modal('hide');
                }, 1500);
            } else {
                $('#detection-error').removeClass('d-none').text(data.message);
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save configuration';
            $('#detection-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}


// ==================== AF-Packet Configuration ====================
function openAfPacketModal() {
    $('#af-packet-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#af-packet-success').addClass('d-none').text('');
    $('#af-packet-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading AF-Packet configuration...</p>');
    $('#afPacketModal').modal('show');
    loadAfPacketConfig();
}

function loadAfPacketConfig() {
    $.ajax({
        url: '/api/suricata-config/af-packet',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#af-packet-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                } else {
                    $('#af-packet-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                }
                afPacketConfig = data.af_packet || {};
                renderAfPacket(afPacketConfig);
            } else {
                $('#af-packet-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to load AF-Packet configuration');
                $('#af-packet-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load AF-Packet configuration';
            $('#af-packet-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
            $('#af-packet-container').html('');
        }
    });
}

function renderAfPacket(config) {
    afPacketConfig = config || {};

    const interfaceName = afPacketConfig.interface || '';
    const threads = afPacketConfig.threads || 'auto';
    const clusterId = afPacketConfig['cluster-id'] !== undefined ? afPacketConfig['cluster-id'] : '';
    const clusterType = afPacketConfig['cluster-type'] || 'cluster_flow';
    const ringSize = afPacketConfig['ring-size'] !== undefined ? afPacketConfig['ring-size'] : '';
    const blockSize = afPacketConfig['block-size'] !== undefined ? afPacketConfig['block-size'] : '';
    const bufferSize = afPacketConfig['buffer-size'] !== undefined ? afPacketConfig['buffer-size'] : '';
    const defrag = toBoolean(afPacketConfig.defrag, true);
    const useMmap = toBoolean(afPacketConfig['use-mmap'], true);
    const tpacketV3 = toBoolean(afPacketConfig['tpacket-v3'], true);
    const promisc = toBoolean(afPacketConfig.promisc, true);

    let html = '<div class="row g-3">';
    html += `
        <div class="col-md-6">
            <label class="form-label">Interface</label>
            <input type="text" class="form-control" id="af-packet-interface" value="${escapeHtml(interfaceName)}" placeholder="eth0">
            <small class="text-muted">Network interface used for AF-Packet capture.</small>
        </div>`;
    html += `
        <div class="col-md-6">
            <label class="form-label">Threads</label>
            <input type="text" class="form-control" id="af-packet-threads" value="${escapeHtml(threads)}" placeholder="auto">
            <small class="text-muted">Number of reader threads (use <code>auto</code> to match CPU cores).</small>
        </div>`;
    html += `
        <div class="col-md-4">
            <label class="form-label">Cluster ID</label>
            <input type="text" class="form-control" id="af-packet-cluster-id" value="${escapeHtml(clusterId)}" placeholder="99">
        </div>`;
    html += `
        <div class="col-md-4">
            <label class="form-label">Cluster Type</label>
            <select class="form-select" id="af-packet-cluster-type">
                ${['cluster_flow', 'cluster_cpu', 'cluster_qm'].map(option => `<option value="${option}"${option === clusterType ? ' selected' : ''}>${option}</option>`).join('')}
            </select>
        </div>`;
    html += `
        <div class="col-md-4">
            <label class="form-label">Ring Size</label>
            <input type="number" min="0" class="form-control" id="af-packet-ring-size" value="${escapeHtml(ringSize)}" placeholder="Default">
        </div>`;

    html += `
        <div class="col-md-4">
            <label class="form-label">Block Size</label>
            <input type="number" min="0" class="form-control" id="af-packet-block-size" value="${escapeHtml(blockSize)}" placeholder="Default">
        </div>`;
    html += `
        <div class="col-md-4">
            <label class="form-label">Buffer Size</label>
            <input type="number" min="0" class="form-control" id="af-packet-buffer-size" value="${escapeHtml(bufferSize)}" placeholder="Default">
        </div>`;

    html += '<div class="col-md-12">';
    html += '    <div class="row">';
    [
        { id: 'af-packet-defrag', label: 'Enable Defrag', checked: defrag },
        { id: 'af-packet-use-mmap', label: 'Use mmap()', checked: useMmap },
        { id: 'af-packet-tpacket-v3', label: 'Enable TPACKET v3', checked: tpacketV3 },
        { id: 'af-packet-promisc', label: 'Promiscuous Mode', checked: promisc }
    ].forEach(option => {
        html += `
            <div class="col-md-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="${option.id}"${option.checked ? ' checked' : ''}>
                    <label class="form-check-label" for="${option.id}">${option.label}</label>
                </div>
            </div>`;
    });
    html += '    </div>';
    html += '</div>';
    html += '</div>';

    $('#af-packet-container').html(html);
}

function saveAfPacketConfig() {
    $('#af-packet-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#af-packet-success').addClass('d-none').text('');

    const $btn = $('#save-af-packet-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const payload = Object.assign({}, afPacketConfig || {});

    const interfaceName = $('#af-packet-interface').val().trim();
    if (interfaceName) {
        payload.interface = interfaceName;
    } else {
        delete payload.interface;
    }

    const threads = $('#af-packet-threads').val().trim();
    if (threads) {
        payload.threads = threads;
    } else {
        delete payload.threads;
    }

    const clusterIdRaw = $('#af-packet-cluster-id').val().trim();
    if (clusterIdRaw) {
        const parsed = parseInt(clusterIdRaw, 10);
        payload['cluster-id'] = Number.isNaN(parsed) ? clusterIdRaw : parsed;
    } else {
        delete payload['cluster-id'];
    }

    payload['cluster-type'] = $('#af-packet-cluster-type').val();

    const ringSizeRaw = $('#af-packet-ring-size').val().trim();
    if (ringSizeRaw) {
        const parsedRing = parseInt(ringSizeRaw, 10);
        payload['ring-size'] = Number.isNaN(parsedRing) ? ringSizeRaw : parsedRing;
    } else {
        delete payload['ring-size'];
    }

    const blockSizeRaw = $('#af-packet-block-size').val().trim();
    if (blockSizeRaw) {
        const parsedBlock = parseInt(blockSizeRaw, 10);
        payload['block-size'] = Number.isNaN(parsedBlock) ? blockSizeRaw : parsedBlock;
    } else {
        delete payload['block-size'];
    }

    const bufferSizeRaw = $('#af-packet-buffer-size').val().trim();
    if (bufferSizeRaw) {
        const parsedBuffer = parseInt(bufferSizeRaw, 10);
        payload['buffer-size'] = Number.isNaN(parsedBuffer) ? bufferSizeRaw : parsedBuffer;
    } else {
        delete payload['buffer-size'];
    }

    payload.defrag = $('#af-packet-defrag').is(':checked');
    payload['use-mmap'] = $('#af-packet-use-mmap').is(':checked');
    payload['tpacket-v3'] = $('#af-packet-tpacket-v3').is(':checked');
    payload.promisc = $('#af-packet-promisc').is(':checked');

    $.ajax({
        url: '/api/suricata-config/af-packet',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ af_packet: payload }),
        success: function(data) {
            if (data.success) {
                afPacketConfig = payload;
                $('#af-packet-success').removeClass('d-none').text(data.message || 'Configuration saved.');
                setTimeout(function() {
                    $('#afPacketModal').modal('hide');
                }, 1200);
            } else {
                $('#af-packet-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to save AF-Packet configuration');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save AF-Packet configuration';
            $('#af-packet-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

// ==================== Packet Capture Configuration (New Unified) ====================
let currentCaptureType = 'af-packet';
let packetCaptureConfig = {};

function openPacketCaptureModal(captureType = 'af-packet') {
    currentCaptureType = captureType;
    $('#packet-capture-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#packet-capture-success').addClass('d-none').text('');
    $('#capture-type-selector').val(captureType);
    $('#packet-capture-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading packet capture configuration...</p>');
    $('#packetCaptureModal').modal('show');
    loadPacketCaptureConfig(captureType);
}

$('#capture-type-selector').on('change', function() {
    const captureType = $(this).val();
    currentCaptureType = captureType;
    loadPacketCaptureConfig(captureType);
});

function loadPacketCaptureConfig(captureType) {
    $.ajax({
        url: `/api/suricata-config/packet-capture/${captureType}`,
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#packet-capture-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                } else {
                    $('#packet-capture-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                }
                packetCaptureConfig = data.config || {};
                renderPacketCapture(captureType, packetCaptureConfig);
            } else {
                $('#packet-capture-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to load packet capture configuration');
                $('#packet-capture-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load packet capture configuration';
            $('#packet-capture-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
            $('#packet-capture-container').html('');
        }
    });
}

function renderPacketCapture(captureType, config) {
    packetCaptureConfig = config || {};
    let html = '<div class="row g-3">';

    if (captureType === 'af-packet') {
        html += renderAfPacketFields(config);
    } else if (captureType === 'af-xdp') {
        html += renderAfXdpFields(config);
    } else if (captureType === 'dpdk') {
        html += renderDpdkFields(config);
    } else if (captureType === 'pcap') {
        html += renderPcapFields(config);
    }

    html += '</div>';
    $('#packet-capture-container').html(html);
}

function renderAfPacketFields(config) {
    const interfaceName = config.interface || '';
    const threads = config.threads || 'auto';
    const clusterId = config['cluster-id'] !== undefined ? config['cluster-id'] : 99;
    const clusterType = config['cluster-type'] || 'cluster_flow';
    const defrag = toBoolean(config.defrag, true);
    const useMmap = toBoolean(config['use-mmap'], true);
    const tpacketV3 = toBoolean(config['tpacket-v3'], true);
    const promisc = toBoolean(config.promisc, true);

    return `
        <div class="col-md-6">
            <label class="form-label">Interface</label>
            <input type="text" class="form-control" id="capture-interface" value="${escapeHtml(interfaceName)}" placeholder="eth0">
            <small class="text-muted">Network interface for AF-Packet capture.</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Threads</label>
            <input type="text" class="form-control" id="capture-threads" value="${escapeHtml(threads)}" placeholder="auto">
            <small class="text-muted">Number of reader threads (use <code>auto</code> to match CPU cores).</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Cluster ID</label>
            <input type="number" class="form-control" id="capture-cluster-id" value="${escapeHtml(clusterId)}" placeholder="99">
        </div>
        <div class="col-md-6">
            <label class="form-label">Cluster Type</label>
            <select class="form-select" id="capture-cluster-type">
                ${['cluster_flow', 'cluster_cpu', 'cluster_qm'].map(option => `<option value="${option}"${option === clusterType ? ' selected' : ''}>${option}</option>`).join('')}
            </select>
        </div>
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="capture-defrag" ${defrag ? 'checked' : ''}>
                        <label class="form-check-label" for="capture-defrag">Enable Defrag</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="capture-use-mmap" ${useMmap ? 'checked' : ''}>
                        <label class="form-check-label" for="capture-use-mmap">Use mmap()</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="capture-tpacket-v3" ${tpacketV3 ? 'checked' : ''}>
                        <label class="form-check-label" for="capture-tpacket-v3">TPACKET v3</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="capture-promisc" ${promisc ? 'checked' : ''}>
                        <label class="form-check-label" for="capture-promisc">Promiscuous Mode</label>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderAfXdpFields(config) {
    const interfaceName = config.interface || '';
    const threads = config.threads || 'auto';
    const busyPoll = toBoolean(config['enable-busy-poll'], true);
    const busyPollTime = config['busy-poll-time'] || 20;
    const busyPollBudget = config['busy-poll-budget'] || 64;

    return `
        <div class="col-md-6">
            <label class="form-label">Interface</label>
            <input type="text" class="form-control" id="capture-interface" value="${escapeHtml(interfaceName)}" placeholder="eth0">
            <small class="text-muted">Network interface for AF-XDP capture.</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Threads</label>
            <input type="text" class="form-control" id="capture-threads" value="${escapeHtml(threads)}" placeholder="auto">
            <small class="text-muted">Number of reader threads.</small>
        </div>
        <div class="col-md-4">
            <label class="form-label">Busy Poll Time</label>
            <input type="number" class="form-control" id="capture-busy-poll-time" value="${escapeHtml(busyPollTime)}" placeholder="20">
            <small class="text-muted">Microseconds to busy poll.</small>
        </div>
        <div class="col-md-4">
            <label class="form-label">Busy Poll Budget</label>
            <input type="number" class="form-control" id="capture-busy-poll-budget" value="${escapeHtml(busyPollBudget)}" placeholder="64">
            <small class="text-muted">Number of packets to process per poll.</small>
        </div>
        <div class="col-md-4">
            <div class="form-check form-switch mt-4">
                <input type="checkbox" class="form-check-input" id="capture-busy-poll" ${busyPoll ? 'checked' : ''}>
                <label class="form-check-label" for="capture-busy-poll">Enable Busy Poll</label>
            </div>
        </div>
    `;
}

function renderDpdkFields(config) {
    const procType = config['eal-params'] ? config['eal-params']['proc-type'] || 'primary' : 'primary';
    const interfaces = config.interfaces || [];
    const firstInterface = interfaces.length > 0 ? interfaces[0] : {};

    const interfacePCI = firstInterface.interface || '0000:3b:00.0';
    const threads = firstInterface.threads || 'auto';
    const promisc = toBoolean(firstInterface.promisc, true);
    const multicast = toBoolean(firstInterface.multicast, true);
    const checksumChecks = toBoolean(firstInterface['checksum-checks'], true);
    const checksumOffload = toBoolean(firstInterface['checksum-checks-offload'], true);
    const mtu = firstInterface.mtu || 1500;
    const mempoolSize = firstInterface['mempool-size'] || 65535;
    const mempoolCacheSize = firstInterface['mempool-cache-size'] || 257;
    const rxDescriptors = firstInterface['rx-descriptors'] || 1024;
    const txDescriptors = firstInterface['tx-descriptors'] || 1024;
    const copyMode = firstInterface['copy-mode'] || 'none';
    const copyIface = firstInterface['copy-iface'] || 'none';

    return `
        <div class="col-md-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> <strong>DPDK configuration is advanced.</strong> Ensure your system has DPDK properly installed and configured with hugepages.
            </div>
        </div>

        <!-- EAL Parameters Section -->
        <div class="col-md-12">
            <h6 class="border-bottom pb-2"><i class="fas fa-cogs"></i> EAL Parameters</h6>
        </div>
        <div class="col-md-6">
            <label class="form-label">Process Type</label>
            <select class="form-select" id="capture-proc-type">
                <option value="primary"${procType === 'primary' ? ' selected' : ''}>Primary</option>
                <option value="secondary"${procType === 'secondary' ? ' selected' : ''}>Secondary</option>
            </select>
            <small class="text-muted">DPDK EAL process type.</small>
        </div>

        <!-- Interface Configuration Section -->
        <div class="col-md-12 mt-3">
            <h6 class="border-bottom pb-2"><i class="fas fa-network-wired"></i> Interface Configuration</h6>
        </div>
        <div class="col-md-6">
            <label class="form-label">PCIe Address <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="capture-pci-address" value="${escapeHtml(interfacePCI)}" placeholder="0000:3b:00.0">
            <small class="text-muted">PCIe address of the NIC port (use <code>lspci | grep Ethernet</code>)</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Threads</label>
            <input type="text" class="form-control" id="capture-threads" value="${escapeHtml(threads)}" placeholder="auto">
            <small class="text-muted">Number of RX/TX queues (<code>auto</code> = all available cores)</small>
        </div>

        <!-- Network Settings -->
        <div class="col-md-12 mt-3">
            <h6 class="border-bottom pb-2"><i class="fas fa-sliders-h"></i> Network Settings</h6>
        </div>
        <div class="col-md-4">
            <label class="form-label">MTU</label>
            <input type="number" class="form-control" id="capture-mtu" value="${escapeHtml(mtu)}" placeholder="1500">
            <small class="text-muted">Maximum Transmission Unit (bytes)</small>
        </div>
        <div class="col-md-4">
            <div class="form-check form-switch mt-4">
                <input type="checkbox" class="form-check-input" id="capture-promisc" ${promisc ? 'checked' : ''}>
                <label class="form-check-label" for="capture-promisc">Promiscuous Mode</label>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-check form-switch mt-4">
                <input type="checkbox" class="form-check-input" id="capture-multicast" ${multicast ? 'checked' : ''}>
                <label class="form-check-label" for="capture-multicast">Multicast</label>
            </div>
        </div>

        <!-- Checksum Settings -->
        <div class="col-md-6">
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="capture-checksum-checks" ${checksumChecks ? 'checked' : ''}>
                <label class="form-check-label" for="capture-checksum-checks">Checksum Validation</label>
            </div>
            <small class="text-muted">Enable checksum validation by Suricata</small>
        </div>
        <div class="col-md-6">
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="capture-checksum-offload" ${checksumOffload ? 'checked' : ''}>
                <label class="form-check-label" for="capture-checksum-offload">Checksum Offload</label>
            </div>
            <small class="text-muted">Offload checksum validation to NIC (saves CPU)</small>
        </div>

        <!-- Memory Settings -->
        <div class="col-md-12 mt-3">
            <h6 class="border-bottom pb-2"><i class="fas fa-memory"></i> Memory Pool Settings</h6>
        </div>
        <div class="col-md-6">
            <label class="form-label">Mempool Size</label>
            <input type="number" class="form-control" id="capture-mempool-size" value="${escapeHtml(mempoolSize)}" placeholder="65535">
            <small class="text-muted">Number of elements in mbuf pool (optimum: 2^n - 1)</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Mempool Cache Size</label>
            <input type="number" class="form-control" id="capture-mempool-cache-size" value="${escapeHtml(mempoolCacheSize)}" placeholder="257">
            <small class="text-muted">Cache size (≤ 512 and ≤ mempool-size/1.5)</small>
        </div>

        <!-- Descriptors -->
        <div class="col-md-12 mt-3">
            <h6 class="border-bottom pb-2"><i class="fas fa-layer-group"></i> Ring Descriptors</h6>
        </div>
        <div class="col-md-6">
            <label class="form-label">RX Descriptors</label>
            <input type="number" class="form-control" id="capture-rx-descriptors" value="${escapeHtml(rxDescriptors)}" placeholder="1024">
            <small class="text-muted">Number of receive descriptors</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">TX Descriptors</label>
            <input type="number" class="form-control" id="capture-tx-descriptors" value="${escapeHtml(txDescriptors)}" placeholder="1024">
            <small class="text-muted">Number of transmit descriptors</small>
        </div>

        <!-- IPS Mode -->
        <div class="col-md-12 mt-3">
            <h6 class="border-bottom pb-2"><i class="fas fa-shield-alt"></i> IPS Mode</h6>
        </div>
        <div class="col-md-6">
            <label class="form-label">Copy Mode</label>
            <select class="form-select" id="capture-copy-mode">
                <option value="none"${copyMode === 'none' ? ' selected' : ''}>None (IDS Mode)</option>
                <option value="tap"${copyMode === 'tap' ? ' selected' : ''}>TAP (Forward All + Alerts)</option>
                <option value="ips"${copyMode === 'ips' ? ' selected' : ''}>IPS (Forward + Drop)</option>
            </select>
            <small class="text-muted">IPS mode for inline deployment</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Copy Interface</label>
            <input type="text" class="form-control" id="capture-copy-iface" value="${escapeHtml(copyIface)}" placeholder="0000:3b:00.1">
            <small class="text-muted">PCIe address of second interface (for IPS mode)</small>
        </div>

        <div class="col-md-12 mt-3">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Memory Calculation:</strong> Required hugepages ≈ (mempool-size × MTU) bytes per interface
            </div>
        </div>
    `;
}

function renderPcapFields(config) {
    const interfaceName = config.interface || '';

    return `
        <div class="col-md-12">
            <label class="form-label">Interface</label>
            <input type="text" class="form-control" id="capture-interface" value="${escapeHtml(interfaceName)}" placeholder="eth0">
            <small class="text-muted">Network interface for PCAP capture.</small>
        </div>
        <div class="col-md-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> PCAP is the legacy packet capture method. Consider using AF-Packet or AF-XDP for better performance.
            </div>
        </div>
    `;
}

function savePacketCaptureConfig() {
    $('#packet-capture-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#packet-capture-success').addClass('d-none').text('');

    const $btn = $('#save-packet-capture-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const payload = {};
    const captureType = currentCaptureType;

    if (captureType === 'af-packet') {
        payload.interface = $('#capture-interface').val().trim();
        payload.threads = $('#capture-threads').val().trim() || 'auto';
        const clusterId = parseInt($('#capture-cluster-id').val(), 10);
        if (!isNaN(clusterId)) payload['cluster-id'] = clusterId;
        payload['cluster-type'] = $('#capture-cluster-type').val();
        payload.defrag = $('#capture-defrag').is(':checked');
        payload['use-mmap'] = $('#capture-use-mmap').is(':checked');
        payload['tpacket-v3'] = $('#capture-tpacket-v3').is(':checked');
        payload.promisc = $('#capture-promisc').is(':checked');
    } else if (captureType === 'af-xdp') {
        payload.interface = $('#capture-interface').val().trim();
        payload.threads = $('#capture-threads').val().trim() || 'auto';
        payload['enable-busy-poll'] = $('#capture-busy-poll').is(':checked');
        const busyPollTime = parseInt($('#capture-busy-poll-time').val(), 10);
        if (!isNaN(busyPollTime)) payload['busy-poll-time'] = busyPollTime;
        const busyPollBudget = parseInt($('#capture-busy-poll-budget').val(), 10);
        if (!isNaN(busyPollBudget)) payload['busy-poll-budget'] = busyPollBudget;
    } else if (captureType === 'dpdk') {
        payload['eal-params'] = {
            'proc-type': $('#capture-proc-type').val()
        };

        // Build interface configuration
        const interfaceConfig = {
            'interface': $('#capture-pci-address').val().trim() || '0000:3b:00.0',
            'threads': $('#capture-threads').val().trim() || 'auto',
            'promisc': $('#capture-promisc').is(':checked'),
            'multicast': $('#capture-multicast').is(':checked'),
            'checksum-checks': $('#capture-checksum-checks').is(':checked'),
            'checksum-checks-offload': $('#capture-checksum-offload').is(':checked'),
        };

        const mtu = parseInt($('#capture-mtu').val(), 10);
        if (!isNaN(mtu)) interfaceConfig.mtu = mtu;

        const mempoolSize = parseInt($('#capture-mempool-size').val(), 10);
        if (!isNaN(mempoolSize)) interfaceConfig['mempool-size'] = mempoolSize;

        const mempoolCacheSize = parseInt($('#capture-mempool-cache-size').val(), 10);
        if (!isNaN(mempoolCacheSize)) interfaceConfig['mempool-cache-size'] = mempoolCacheSize;

        const rxDescriptors = parseInt($('#capture-rx-descriptors').val(), 10);
        if (!isNaN(rxDescriptors)) interfaceConfig['rx-descriptors'] = rxDescriptors;

        const txDescriptors = parseInt($('#capture-tx-descriptors').val(), 10);
        if (!isNaN(txDescriptors)) interfaceConfig['tx-descriptors'] = txDescriptors;

        interfaceConfig['copy-mode'] = $('#capture-copy-mode').val();
        interfaceConfig['copy-iface'] = $('#capture-copy-iface').val().trim() || 'none';

        payload.interfaces = [interfaceConfig];
    } else if (captureType === 'pcap') {
        payload.interface = $('#capture-interface').val().trim();
    }

    $.ajax({
        url: `/api/suricata-config/packet-capture/${captureType}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ config: payload }),
        success: function(data) {
            if (data.success) {
                packetCaptureConfig = payload;
                $('#packet-capture-success').removeClass('d-none').text(data.message || 'Configuration saved.');
                setTimeout(function() {
                    $('#packetCaptureModal').modal('hide');
                }, 1200);
            } else {
                $('#packet-capture-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to save packet capture configuration');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save packet capture configuration';
            $('#packet-capture-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-packet-capture-btn').off('click').on('click', savePacketCaptureConfig);

// ==================== Stream Configuration ====================
function openStreamModal() {
    $('#stream-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#stream-success').addClass('d-none').text('');
    $('#stream-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading stream configuration...</p>');
    $('#streamModal').modal('show');
    loadStreamConfig();
}

function loadStreamConfig() {
    $.ajax({
        url: '/api/suricata-config/stream',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#stream-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                } else {
                    $('#stream-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                }
                streamConfig = data.stream || {};
                renderStream(streamConfig);
            } else {
                $('#stream-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to load stream configuration');
                $('#stream-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load stream configuration';
            $('#stream-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
            $('#stream-container').html('');
        }
    });
}

function renderStream(config) {
    streamConfig = config || {};
    const reassembly = Object.assign({}, streamConfig.reassembly || {});

    const memcap = streamConfig.memcap || '32mb';
    const checksum = streamConfig['checksum-validation'] || 'auto';
    const inlineMode = streamConfig.inline || 'auto';
    const preallocSessions = streamConfig['prealloc-sessions'] !== undefined ? streamConfig['prealloc-sessions'] : '';

    const reassemblyMemcap = reassembly.memcap || '64mb';
    const reassemblyDepth = reassembly.depth || '1mb';
    const reassemblyToServer = reassembly['toserver-chunk-size'] !== undefined ? reassembly['toserver-chunk-size'] : 2560;
    const reassemblyToClient = reassembly['toclient-chunk-size'] !== undefined ? reassembly['toclient-chunk-size'] : 2560;

    let html = '<div class="row g-3">';
    html += `
        <div class="col-md-6">
            <label class="form-label">Stream Memcap</label>
            <input type="text" class="form-control" id="stream-memcap" value="${escapeHtml(memcap)}" placeholder="32mb">
        </div>`;
    html += `
        <div class="col-md-6">
            <label class="form-label">Checksum Validation</label>
            <select class="form-select" id="stream-checksum">
                ${['auto', 'yes', 'no'].map(option => `<option value="${option}"${option === checksum ? ' selected' : ''}>${option.toUpperCase()}</option>`).join('')}
            </select>
        </div>`;
    html += `
        <div class="col-md-6">
            <label class="form-label">Inline Mode</label>
            <select class="form-select" id="stream-inline">
                ${['auto', 'yes', 'no'].map(option => `<option value="${option}"${option === inlineMode ? ' selected' : ''}>${option.toUpperCase()}</option>`).join('')}
            </select>
        </div>`;
    html += `
        <div class="col-md-6">
            <label class="form-label">Prealloc Sessions</label>
            <input type="number" min="0" class="form-control" id="stream-prealloc" value="${escapeHtml(preallocSessions)}" placeholder="4096">
        </div>`;

    html += '<div class="col-12">';
    html += '<h6 class="mt-2"><i class="fas fa-layer-group"></i> Reassembly</h6>';
    html += '<div class="row g-3">';
    html += `
        <div class="col-md-3">
            <label class="form-label">Memcap</label>
            <input type="text" class="form-control" id="stream-reassembly-memcap" value="${escapeHtml(reassemblyMemcap)}" placeholder="64mb">
        </div>`;
    html += `
        <div class="col-md-3">
            <label class="form-label">Depth</label>
            <input type="text" class="form-control" id="stream-reassembly-depth" value="${escapeHtml(reassemblyDepth)}" placeholder="1mb">
        </div>`;
    html += `
        <div class="col-md-3">
            <label class="form-label">To-Server Chunk Size</label>
            <input type="number" min="0" class="form-control" id="stream-reassembly-toserver" value="${escapeHtml(reassemblyToServer)}">
        </div>`;
    html += `
        <div class="col-md-3">
            <label class="form-label">To-Client Chunk Size</label>
            <input type="number" min="0" class="form-control" id="stream-reassembly-toclient" value="${escapeHtml(reassemblyToClient)}">
        </div>`;
    html += '</div>';
    html += '</div>';

    html += '</div>';

    $('#stream-container').html(html);
}

function saveStreamConfig() {
    $('#stream-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#stream-success').addClass('d-none').text('');

    const $btn = $('#save-stream-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const payload = Object.assign({}, streamConfig || {});

    const memcap = $('#stream-memcap').val().trim();
    if (memcap) {
        payload.memcap = memcap;
    } else {
        delete payload.memcap;
    }

    payload['checksum-validation'] = $('#stream-checksum').val();
    payload.inline = $('#stream-inline').val();

    const preallocRaw = $('#stream-prealloc').val().trim();
    if (preallocRaw) {
        const parsed = parseInt(preallocRaw, 10);
        payload['prealloc-sessions'] = Number.isNaN(parsed) ? preallocRaw : parsed;
    } else {
        delete payload['prealloc-sessions'];
    }

    const reassemblyPayload = Object.assign({}, streamConfig && streamConfig.reassembly ? streamConfig.reassembly : {});
    const reassemblyMemcap = $('#stream-reassembly-memcap').val().trim();
    if (reassemblyMemcap) {
        reassemblyPayload.memcap = reassemblyMemcap;
    } else {
        delete reassemblyPayload.memcap;
    }

    const reassemblyDepth = $('#stream-reassembly-depth').val().trim();
    if (reassemblyDepth) {
        reassemblyPayload.depth = reassemblyDepth;
    } else {
        delete reassemblyPayload.depth;
    }

    const reassemblyToServer = $('#stream-reassembly-toserver').val().trim();
    if (reassemblyToServer) {
        const parsedServer = parseInt(reassemblyToServer, 10);
        reassemblyPayload['toserver-chunk-size'] = Number.isNaN(parsedServer) ? reassemblyToServer : parsedServer;
    } else {
        delete reassemblyPayload['toserver-chunk-size'];
    }

    const reassemblyToClient = $('#stream-reassembly-toclient').val().trim();
    if (reassemblyToClient) {
        const parsedClient = parseInt(reassemblyToClient, 10);
        reassemblyPayload['toclient-chunk-size'] = Number.isNaN(parsedClient) ? reassemblyToClient : parsedClient;
    } else {
        delete reassemblyPayload['toclient-chunk-size'];
    }

    payload.reassembly = reassemblyPayload;

    $.ajax({
        url: '/api/suricata-config/stream',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ stream: payload }),
        success: function(data) {
            if (data.success) {
                streamConfig = payload;
                $('#stream-success').removeClass('d-none').text(data.message || 'Configuration saved.');
                setTimeout(function() {
                    $('#streamModal').modal('hide');
                }, 1200);
            } else {
                $('#stream-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to save stream configuration');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save stream configuration';
            $('#stream-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

// ==================== Variables Configuration ====================
function openVarsModal() {
    $('#vars-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#vars-success').addClass('d-none').text('');
    $('#vars-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading variables...</p>');
    $('#varsModal').modal('show');
    loadVarsConfig();
}

function loadVarsConfig() {
    $.ajax({
        url: '/api/suricata-config/vars',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#vars-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                } else {
                    $('#vars-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                }
                varsConfig = data.vars || {};
                renderVars(varsConfig);
            } else {
                $('#vars-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to load variables');
                $('#vars-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load variables';
            $('#vars-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
            $('#vars-container').html('');
        }
    });
}

function renderVars(config) {
    varsConfig = config || {};
    const entries = Object.entries(varsConfig);

    let html = '<div class="table-responsive">';
    html += '<table class="table table-sm align-middle">';
    html += '<thead><tr><th style="width: 30%">Name</th><th>Value</th><th style="width: 40px" class="text-center">&nbsp;</th></tr></thead>';
    html += '<tbody id="vars-table-body"></tbody>';
    html += '</table>';
    html += '</div>';
    html += '<button type="button" class="btn btn-outline-primary btn-sm" id="add-var-row"><i class="fas fa-plus"></i> Add Variable</button>';
    html += '<small class="text-muted d-block mt-2">Values accept plain strings or JSON objects/arrays for complex definitions.</small>';

    $('#vars-container').html(html);

    const $tbody = $('#vars-table-body');
    if (entries.length === 0) {
        addVarRow();
    } else {
        entries.forEach(([name, value]) => {
            addVarRow(name, valueToDisplay(value));
        });
    }

    $('#add-var-row').off('click').on('click', function() {
        addVarRow();
    });

    $tbody.off('click', '.remove-var-row').on('click', '.remove-var-row', function() {
        $(this).closest('tr').remove();
    });
}

function addVarRow(name = '', value = '') {
    const $tbody = $('#vars-table-body');
    if (!$tbody.length) {
        return;
    }
    const rowHtml = `
        <tr class="var-row">
            <td>
                <input type="text" class="form-control var-name" value="${escapeHtml(name)}" placeholder="VAR_NAME">
            </td>
            <td>
                <textarea class="form-control var-value" rows="2" placeholder="Value (string or JSON)">${escapeHtml(value)}</textarea>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-var-row" title="Remove"><i class="fas fa-times"></i></button>
            </td>
        </tr>`;
    $tbody.append(rowHtml);
}

function valueToDisplay(value) {
    if (value === null || value === undefined) {
        return '';
    }
    if (typeof value === 'object') {
        try {
            return JSON.stringify(value, null, 2);
        } catch (err) {
            return String(value);
        }
    }
    return String(value);
}

function parseVarValue(raw) {
    if (raw === null || raw === undefined) {
        return '';
    }
    const trimmed = raw.trim();
    if (!trimmed) {
        return '';
    }
    if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
        try {
            return JSON.parse(trimmed);
        } catch (err) {
            throw new Error('Invalid JSON value: ' + err.message);
        }
    }
    return trimmed;
}

function saveVarsConfig() {
    $('#vars-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#vars-success').addClass('d-none').text('');

    const $btn = $('#save-vars-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const result = {};
    let hasError = false;
    let errorMessage = '';

    $('#vars-table-body tr').each(function() {
        const name = $(this).find('.var-name').val().trim();
        const valueRaw = $(this).find('.var-value').val();

        if (!name) {
            return;
        }

        try {
            result[name] = parseVarValue(valueRaw || '');
        } catch (err) {
            hasError = true;
            errorMessage = err.message || 'Invalid value';
            return false; // break
        }
    });

    if (hasError) {
        $('#vars-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(errorMessage);
        $btn.prop('disabled', false).html(originalHtml);
        return;
    }

    if (Object.keys(result).length === 0) {
        $('#vars-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('Please define at least one variable before saving.');
        $btn.prop('disabled', false).html(originalHtml);
        return;
    }

    $.ajax({
        url: '/api/suricata-config/vars',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ vars: result }),
        success: function(data) {
            if (data.success) {
                varsConfig = result;
                $('#vars-success').removeClass('d-none').text(data.message || 'Variables saved successfully.');
                setTimeout(function() {
                    $('#varsModal').modal('hide');
                }, 1200);
            } else {
                $('#vars-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to save variables');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save variables';
            $('#vars-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-af-packet-btn').off('click').on('click', saveAfPacketConfig);
$('#save-stream-btn').off('click').on('click', saveStreamConfig);
$('#save-vars-btn').off('click').on('click', saveVarsConfig);

$('#save-detection-btn').click(saveDetectionConfig);

// ==================== Host Configuration ====================
let hostConfig = {};

function openHostModal() {
    $('#host-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#host-success').addClass('d-none').text('');
    $('#host-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading host configuration...</p>');
    $('#hostModal').modal('show');
    loadHostConfig();
}

function loadHostConfig() {
    $.ajax({
        url: '/api/suricata-config/host',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#host-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                } else {
                    $('#host-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                }
                hostConfig = data.host || {};
                renderHost(hostConfig);
            } else {
                $('#host-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to load host configuration');
                $('#host-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load host configuration';
            $('#host-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
            $('#host-container').html('');
        }
    });
}

function renderHost(config) {
    hostConfig = config || {};

    const hashSize = hostConfig['hash-size'] || 4096;
    const prealloc = hostConfig['prealloc'] || 1000;
    const memcap = hostConfig['memcap'] || '32mb';

    let html = '<div class="row g-3">';

    html += `
        <div class="col-md-4">
            <label class="form-label"><i class="fas fa-hashtag"></i> Hash Size</label>
            <input type="number" min="1" class="form-control" id="host-hash-size" value="${escapeHtml(hashSize)}" placeholder="4096">
            <small class="text-muted">Hash table size for host tracking (higher = more memory, better performance)</small>
        </div>`;

    html += `
        <div class="col-md-4">
            <label class="form-label"><i class="fas fa-database"></i> Preallocate Hosts</label>
            <input type="number" min="0" class="form-control" id="host-prealloc" value="${escapeHtml(prealloc)}" placeholder="1000">
            <small class="text-muted">Number of host structures to preallocate at startup</small>
        </div>`;

    html += `
        <div class="col-md-4">
            <label class="form-label"><i class="fas fa-memory"></i> Memory Cap</label>
            <input type="text" class="form-control" id="host-memcap" value="${escapeHtml(memcap)}" placeholder="32mb">
            <small class="text-muted">Maximum memory for host table (e.g., 32mb, 64mb, 128mb)</small>
        </div>`;

    html += '</div>';

    // Additional info section
    html += '<div class="mt-4">';
    html += '<h6 class="border-bottom pb-2"><i class="fas fa-info-circle"></i> Host Table Information</h6>';
    html += '<div class="row mt-3">';
    html += '<div class="col-md-12">';
    html += '<p class="text-muted small mb-2"><strong>What is Host Table?</strong></p>';
    html += '<p class="text-muted small">The host table tracks IP addresses and their associated metadata (OS, services, etc.). This is used for:</p>';
    html += '<ul class="text-muted small">';
    html += '<li>OS detection and policy application</li>';
    html += '<li>Service detection and protocol analysis</li>';
    html += '<li>Performance optimization based on host characteristics</li>';
    html += '</ul>';
    html += '</div>';
    html += '</div>';
    html += '</div>';

    $('#host-container').html(html);
}

function saveHostConfig() {
    $('#host-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#host-success').addClass('d-none').text('');

    const $btn = $('#save-host-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const payload = Object.assign({}, hostConfig || {});

    const hashSizeRaw = $('#host-hash-size').val().trim();
    if (hashSizeRaw) {
        const parsed = parseInt(hashSizeRaw, 10);
        payload['hash-size'] = Number.isNaN(parsed) ? hashSizeRaw : parsed;
    } else {
        delete payload['hash-size'];
    }

    const preallocRaw = $('#host-prealloc').val().trim();
    if (preallocRaw) {
        const parsed = parseInt(preallocRaw, 10);
        payload['prealloc'] = Number.isNaN(parsed) ? preallocRaw : parsed;
    } else {
        delete payload['prealloc'];
    }

    const memcap = $('#host-memcap').val().trim();
    if (memcap) {
        payload['memcap'] = memcap;
    } else {
        delete payload['memcap'];
    }

    $.ajax({
        url: '/api/suricata-config/host',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ host: payload }),
        success: function(data) {
            if (data.success) {
                hostConfig = payload;
                $('#host-success').removeClass('d-none').text(data.message || 'Configuration saved.');
                setTimeout(function() {
                    $('#hostModal').modal('hide');
                }, 1200);
            } else {
                $('#host-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to save host configuration');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save host configuration';
            $('#host-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-host-btn').off('click').on('click', saveHostConfig);

// ==================== IPS/Preventive Configuration ====================
let ipsConfig = {};

function openIpsModal() {
    $('#ips-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#ips-success').addClass('d-none').text('');
    $('#ips-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading IPS configuration...</p>');
    $('#ipsModal').modal('show');
    loadIpsConfig();
}

function loadIpsConfig() {
    $.ajax({
        url: '/api/suricata-config/ips',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                if (data.warning) {
                    $('#ips-error').removeClass('d-none').removeClass('alert-danger').addClass('alert-warning').text(data.warning);
                } else {
                    $('#ips-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                }
                ipsConfig = data.ips || {};
                renderIps(ipsConfig);
            } else {
                $('#ips-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to load IPS configuration');
                $('#ips-container').html('');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to load IPS configuration';
            $('#ips-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
            $('#ips-container').html('');
        }
    });
}

function renderIps(config) {
    ipsConfig = config || {};

    const actionOrder = ipsConfig['action-order'] || ['pass', 'drop', 'reject', 'alert'];
    const defaultAction = ipsConfig['default-rule-action'] || 'alert';
    const afPacketCopyMode = ipsConfig['af-packet-copy-mode'] || '';
    const afPacketCopyIface = ipsConfig['af-packet-copy-iface'] || '';

    let html = '<div class="row g-3">';

    // Default Rule Action
    html += `
        <div class="col-md-6">
            <label class="form-label"><i class="fas fa-exclamation-circle"></i> Default Rule Action</label>
            <select class="form-select" id="ips-default-action">
                ${['alert', 'drop', 'reject', 'pass'].map(action =>
                    `<option value="${action}"${action === defaultAction ? ' selected' : ''}>${action.toUpperCase()}</option>`
                ).join('')}
            </select>
            <small class="text-muted">Default action for rules without explicit action</small>
        </div>`;

    // Action Order
    html += `
        <div class="col-md-6">
            <label class="form-label"><i class="fas fa-list-ol"></i> Action Order Priority</label>
            <input type="text" class="form-control" id="ips-action-order" value="${escapeHtml(actionOrder.join(', '))}" placeholder="pass, drop, reject, alert">
            <small class="text-muted">Action priority order (comma-separated)</small>
        </div>`;

    html += '</div>';

    // AF-Packet IPS Mode Section
    html += '<div class="mt-4">';
    html += '<h6 class="border-bottom pb-2"><i class="fas fa-network-wired"></i> AF-Packet IPS Mode</h6>';
    html += '<div class="row g-3 mt-2">';

    html += `
        <div class="col-md-6">
            <label class="form-label">Copy Mode</label>
            <select class="form-select" id="ips-copy-mode">
                <option value="">Disabled (IDS Mode)</option>
                <option value="ips"${afPacketCopyMode === 'ips' ? ' selected' : ''}>IPS (Inline Mode)</option>
                <option value="tap"${afPacketCopyMode === 'tap' ? ' selected' : ''}>TAP (Copy Mode)</option>
            </select>
            <small class="text-muted">Enable IPS mode for AF-Packet interface</small>
        </div>`;

    html += `
        <div class="col-md-6">
            <label class="form-label">Copy Interface</label>
            <input type="text" class="form-control" id="ips-copy-iface" value="${escapeHtml(afPacketCopyIface)}" placeholder="eth1">
            <small class="text-muted">Destination interface for IPS copy mode</small>
        </div>`;

    html += '</div>';
    html += '</div>';

    // Information Section
    html += '<div class="mt-4">';
    html += '<h6 class="border-bottom pb-2"><i class="fas fa-info-circle"></i> IPS Mode Information</h6>';
    html += '<div class="row mt-3">';
    html += '<div class="col-md-12">';
    html += '<ul class="text-muted small mb-0">';
    html += '<li><strong>ALERT:</strong> Only log the event (IDS mode - passive)</li>';
    html += '<li><strong>DROP:</strong> Block the packet silently (IPS mode - active)</li>';
    html += '<li><strong>REJECT:</strong> Block and send reset/unreachable (IPS mode - active)</li>';
    html += '<li><strong>PASS:</strong> Allow the packet explicitly</li>';
    html += '</ul>';
    html += '<div class="alert alert-danger mt-3 mb-0">';
    html += '<i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> Enabling IPS mode requires proper network configuration. Incorrect settings may cause network disruption.';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';

    $('#ips-container').html(html);
}

function saveIpsConfig() {
    $('#ips-error').addClass('d-none').removeClass('alert-warning').addClass('alert-danger').text('');
    $('#ips-success').addClass('d-none').text('');

    const $btn = $('#save-ips-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    const payload = Object.assign({}, ipsConfig || {});

    // Default action
    payload['default-rule-action'] = $('#ips-default-action').val();

    // Action order
    const actionOrderRaw = $('#ips-action-order').val().trim();
    if (actionOrderRaw) {
        payload['action-order'] = actionOrderRaw.split(',').map(s => s.trim()).filter(s => s);
    } else {
        payload['action-order'] = ['pass', 'drop', 'reject', 'alert'];
    }

    // AF-Packet copy mode
    const copyMode = $('#ips-copy-mode').val();
    if (copyMode) {
        payload['af-packet-copy-mode'] = copyMode;
        payload['af-packet-copy-iface'] = $('#ips-copy-iface').val().trim();
    } else {
        delete payload['af-packet-copy-mode'];
        delete payload['af-packet-copy-iface'];
    }

    $.ajax({
        url: '/api/suricata-config/ips',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ips: payload }),
        success: function(data) {
            if (data.success) {
                ipsConfig = payload;
                $('#ips-success').removeClass('d-none').text(data.message || 'Configuration saved.');
                setTimeout(function() {
                    $('#ipsModal').modal('hide');
                }, 1200);
            } else {
                $('#ips-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(data.message || 'Failed to save IPS configuration');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save IPS configuration';
            $('#ips-error').removeClass('d-none').removeClass('alert-warning').addClass('alert-danger').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-ips-btn').off('click').on('click', saveIpsConfig);

// ==================== Interface Configuration ====================
let systemInterfaces = [];
let configuredInterfaces = [];

function openInterfaceModal() {
    $('#interface-error').addClass('d-none').text('');
    $('#interface-success').addClass('d-none').text('');
    $('#interface-container').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading interfaces...</p>');
    $('#interfaceModal').modal('show');
    loadInterfaceConfig();
}

function loadInterfaceConfig() {
    // Load both system interfaces and configured interfaces
    Promise.all([
        $.get('/api/system/interfaces'),
        $.get('/api/suricata-config/interfaces')
    ]).then(function([sysResult, configResult]) {
        if (sysResult.success) {
            systemInterfaces = sysResult.interfaces || [];
        }
        if (configResult.success) {
            configuredInterfaces = configResult.interfaces || [];
        }
        renderInterfaces();
    }).catch(function(error) {
        $('#interface-error').removeClass('d-none').text('Failed to load interface data');
        $('#interface-container').html('');
    });
}

function renderInterfaces() {
    let html = '';

    // System Interfaces Section
    html += '<h6 class="border-bottom pb-2 mb-3"><i class="fas fa-network-wired"></i> Available System Interfaces</h6>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-sm table-hover">';
    html += '<thead><tr>';
    html += '<th style="width: 30px"><input type="checkbox" id="select-all-interfaces"></th>';
    html += '<th>Interface</th><th>Type</th><th>IPv4</th><th>MAC</th><th>Status</th><th>Config</th>';
    html += '</tr></thead>';
    html += '<tbody>';

    systemInterfaces.forEach(function(iface) {
        const isConfigured = configuredInterfaces.find(c => c.interface === iface.name);
        const isChecked = isConfigured ? 'checked' : '';
        const statusBadge = iface.is_up ? '<span class="badge bg-success">UP</span>' : '<span class="badge bg-secondary">DOWN</span>';

        html += '<tr>';
        html += `<td><input type="checkbox" class="interface-checkbox" data-interface="${escapeHtml(iface.name)}" ${isChecked}></td>`;
        html += `<td><strong>${escapeHtml(iface.name)}</strong></td>`;
        html += `<td><select class="form-select form-select-sm interface-type" data-interface="${escapeHtml(iface.name)}">`;
        html += `<option value="af-packet"${isConfigured && isConfigured.type === 'af-packet' ? ' selected' : ''}>AF-Packet</option>`;
        html += `<option value="af-xdp"${isConfigured && isConfigured.type === 'af-xdp' ? ' selected' : ''}>AF-XDP</option>`;
        html += `<option value="dpdk"${isConfigured && isConfigured.type === 'dpdk' ? ' selected' : ''}>DPDK</option>`;
        html += `<option value="pcap"${isConfigured && isConfigured.type === 'pcap' ? ' selected' : ''}>PCAP</option>`;
        html += `</select></td>`;
        html += `<td class="text-muted small">${iface.ipv4 || '-'}</td>`;
        html += `<td class="text-muted small font-monospace">${iface.mac || '-'}</td>`;
        html += `<td>${statusBadge}</td>`;
        html += `<td><button class="btn btn-sm btn-outline-secondary interface-settings-btn" data-interface="${escapeHtml(iface.name)}" ${!isChecked ? 'disabled' : ''}><i class="fas fa-cog"></i></button></td>`;
        html += '</tr>';
    });

    html += '</tbody>';
    html += '</table>';
    html += '</div>';

    // Info section
    html += '<div class="alert alert-info mt-3 mb-0">';
    html += '<i class="fas fa-info-circle"></i> <strong>Tip:</strong> Select interfaces to monitor, choose capture type (AF-Packet, AF-XDP, DPDK, or PCAP), and click settings to configure advanced options.';
    html += '</div>';

    $('#interface-container').html(html);

    // Event handlers
    $('#select-all-interfaces').on('change', function() {
        $('.interface-checkbox').prop('checked', $(this).is(':checked')).trigger('change');
    });

    $('.interface-checkbox').on('change', function() {
        const $settingsBtn = $(this).closest('tr').find('.interface-settings-btn');
        $settingsBtn.prop('disabled', !$(this).is(':checked'));
    });

    $('.interface-settings-btn').on('click', function() {
        const ifaceName = $(this).data('interface');
        showInterfaceSettings(ifaceName);
    });
}

function showInterfaceSettings(ifaceName) {
    const configured = configuredInterfaces.find(c => c.interface === ifaceName) || {};
    const type = $(`.interface-type[data-interface="${ifaceName}"]`).val();

    let settingsHtml = `<div class="modal-body"><h6>Settings for ${ifaceName} (${type.toUpperCase()})</h6>`;

    if (type === 'af-packet') {
        settingsHtml += '<div class="mb-3">';
        settingsHtml += '<label class="form-label">Threads</label>';
        settingsHtml += `<input type="text" class="form-control" id="iface-threads" value="${configured.threads || 'auto'}" placeholder="auto">`;
        settingsHtml += '</div>';
        settingsHtml += '<div class="mb-3">';
        settingsHtml += '<label class="form-label">Cluster ID</label>';
        settingsHtml += `<input type="number" class="form-control" id="iface-cluster-id" value="${configured['cluster-id'] || 99}">`;
        settingsHtml += '</div>';
        settingsHtml += '<div class="mb-3">';
        settingsHtml += '<label class="form-label">Cluster Type</label>';
        settingsHtml += `<select class="form-select" id="iface-cluster-type">`;
        settingsHtml += `<option value="cluster_flow"${configured['cluster-type'] === 'cluster_flow' ? ' selected' : ''}>Cluster Flow</option>`;
        settingsHtml += `<option value="cluster_cpu"${configured['cluster-type'] === 'cluster_cpu' ? ' selected' : ''}>Cluster CPU</option>`;
        settingsHtml += `<option value="cluster_qm"${configured['cluster-type'] === 'cluster_qm' ? ' selected' : ''}>Cluster QM</option>`;
        settingsHtml += `</select></div>`;
    } else if (type === 'af-xdp') {
        settingsHtml += '<div class="mb-3">';
        settingsHtml += '<label class="form-label">Threads</label>';
        settingsHtml += `<input type="text" class="form-control" id="iface-threads" value="${configured.threads || 'auto'}" placeholder="auto">`;
        settingsHtml += '<small class="text-muted">Number of reader threads</small>';
        settingsHtml += '</div>';
        settingsHtml += '<div class="alert alert-info">';
        settingsHtml += '<i class="fas fa-info-circle"></i> AF-XDP requires kernel 4.18+ and proper XDP support.';
        settingsHtml += '</div>';
    } else if (type === 'dpdk') {
        settingsHtml += '<div class="mb-3">';
        settingsHtml += '<label class="form-label">Threads</label>';
        settingsHtml += `<input type="text" class="form-control" id="iface-threads" value="${configured.threads || 'auto'}" placeholder="auto">`;
        settingsHtml += '<small class="text-muted">Number of reader threads</small>';
        settingsHtml += '</div>';
        settingsHtml += '<div class="alert alert-warning">';
        settingsHtml += '<i class="fas fa-exclamation-triangle"></i> DPDK requires proper DPDK installation and configuration.';
        settingsHtml += '</div>';
    } else if (type === 'pcap') {
        settingsHtml += '<div class="alert alert-info">';
        settingsHtml += '<i class="fas fa-info-circle"></i> PCAP is the legacy packet capture method. No additional settings required.';
        settingsHtml += '</div>';
    }

    settingsHtml += `<button class="btn btn-primary" onclick="saveInterfaceSettings('${ifaceName}', '${type}')">Save</button>`;
    settingsHtml += '</div>';

    // Show in a simple alert (you can make this a separate modal if needed)
    const $row = $(`.interface-settings-btn[data-interface="${ifaceName}"]`).closest('tr');
    if ($row.next('.settings-row').length) {
        $row.next('.settings-row').remove();
    } else {
        $row.after(`<tr class="settings-row"><td colspan="7">${settingsHtml}</td></tr>`);
    }
}

function saveInterfaceSettings(ifaceName, type) {
    const existing = configuredInterfaces.find(c => c.interface === ifaceName);

    const settings = {
        interface: ifaceName,
        type: type,
        enabled: true
    };

    if (type === 'af-packet') {
        settings.threads = $('#iface-threads').val() || 'auto';
        settings['cluster-id'] = parseInt($('#iface-cluster-id').val()) || 99;
        settings['cluster-type'] = $('#iface-cluster-type').val() || 'cluster_flow';
    } else if (type === 'af-xdp' || type === 'dpdk') {
        settings.threads = $('#iface-threads').val() || 'auto';
    } else if (type === 'pcap') {
        // PCAP has no additional settings
    }

    if (existing) {
        Object.assign(existing, settings);
    } else {
        configuredInterfaces.push(settings);
    }

    $(`.interface-settings-btn[data-interface="${ifaceName}"]`).closest('tr').next('.settings-row').remove();
}

function saveInterfaceConfig() {
    $('#interface-error').addClass('d-none').text('');
    $('#interface-success').addClass('d-none').text('');

    const $btn = $('#save-interface-btn');
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    // Collect all selected interfaces
    const interfaces = [];
    $('.interface-checkbox:checked').each(function() {
        const ifaceName = $(this).data('interface');
        const type = $(`.interface-type[data-interface="${ifaceName}"]`).val();
        const existing = configuredInterfaces.find(c => c.interface === ifaceName);

        if (existing) {
            interfaces.push(existing);
        } else {
            // Default settings based on capture type
            const defaultSettings = {
                interface: ifaceName,
                type: type,
                enabled: true
            };

            if (type === 'af-packet') {
                defaultSettings.threads = 'auto';
                defaultSettings['cluster-id'] = 99;
                defaultSettings['cluster-type'] = 'cluster_flow';
            } else if (type === 'af-xdp' || type === 'dpdk') {
                defaultSettings.threads = 'auto';
            }
            // PCAP doesn't need additional settings

            interfaces.push(defaultSettings);
        }
    });

    $.ajax({
        url: '/api/suricata-config/interfaces',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ interfaces: interfaces }),
        success: function(data) {
            if (data.success) {
                $('#interface-success').removeClass('d-none').text(data.message || 'Configuration saved.');
                setTimeout(function() {
                    $('#interfaceModal').modal('hide');
                }, 1200);
            } else {
                $('#interface-error').removeClass('d-none').text(data.message || 'Failed to save interface configuration');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save interface configuration';
            $('#interface-error').removeClass('d-none').text(message);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#save-interface-btn').off('click').on('click', saveInterfaceConfig);
</script>
{% endblock %}




