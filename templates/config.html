{% extends "base.html" %}
{% block title %}Configuration - Suricata Dashboard{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Suricata Configuration</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Configure Suricata settings through an intuitive interface. Click on any section below to modify its configuration.
                </div>

                <!-- Suricata Config Cards -->
                <h6 class="text-uppercase fw-bold text-muted mb-3"><i class="fas fa-cog"></i> Suricata Configuration</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card h-100 border-secondary hover-shadow config-card" data-search="packet-capture" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-network-wired fa-3x text-secondary mb-3"></i>
                                <h5 class="card-title">Packet Capture</h5>
                                <p class="card-text text-muted small">Configure packet capture methods: AF-Packet, AF-XDP, DPDK, PCAP</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-primary hover-shadow config-card" data-search="app-layer" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">App Layer</h5>
                                <p class="card-text text-muted small">Enable/disable application layer protocols</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-success hover-shadow config-card" data-search="outputs" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-file-export fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Outputs</h5>
                                <p class="card-text text-muted small">Configure logging outputs and event formats</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-warning hover-shadow config-card" data-search="logging" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-clipboard-list fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">Logging</h5>
                                <p class="card-text text-muted small">Configure log levels and destinations</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-success hover-shadow config-card" data-search="vars" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Variables</h5>
                                <p class="card-text text-muted small">Manage address and port variables</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-info hover-shadow config-card" data-search="detection" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-3x text-info mb-3"></i>
                                <h5 class="card-title">IDS / Detection</h5>
                                <p class="card-text text-muted small">Configure detection engine and profiling</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-primary hover-shadow config-card" data-search="stream" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-stream fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Stream</h5>
                                <p class="card-text text-muted small">Configure stream engine and reassembly</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-dark hover-shadow config-card" data-search="host" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-server fa-3x text-dark mb-3"></i>
                                <h5 class="card-title">Host</h5>
                                <p class="card-text text-muted small">Configure host table and tracking settings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-danger hover-shadow config-card" data-search="ips" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                                <h5 class="card-title">IPS / Preventive</h5>
                                <p class="card-text text-muted small">Configure inline mode and prevention actions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-info hover-shadow config-card" data-search="interface" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fas fa-ethernet fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Interface</h5>
                                <p class="card-text text-muted small">Configure network interfaces and monitoring</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integration Cards -->
                <h6 class="text-uppercase fw-bold text-muted mb-3 mt-4"><i class="fas fa-plug"></i> Integrations</h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card h-100 border-primary hover-shadow integration-card" data-integration="discord" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fab fa-discord fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Discord</h5>
                                <p class="card-text text-muted small">Configure Discord webhook notifications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-info hover-shadow integration-card" data-integration="telegram" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="fab fa-telegram fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Telegram</h5>
                                <p class="card-text text-muted small">Configure Telegram bot notifications</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
</style>
<div class="modal fade" id="integrationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="integrationModalLabel">Integration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="integration-error"></div>
                <div class="alert alert-success d-none" id="integration-success"></div>
                <div class="text-muted small d-none" id="integration-hash-wrapper">
                    MD5 Hash: <code id="integration-hash-value">-</code>
                </div>
                <input type="hidden" id="integration-name">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="integration-enabled">
                    <label class="form-check-label" for="integration-enabled">Enable integration</label>
                </div>
                <div id="discord-fields" class="integration-fields d-none">
                    <div class="mb-3">
                        <label for="discord-webhook" class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="discord-webhook" placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">Provide a Discord webhook URL with notification permissions.</div>
                    </div>
                    <div class="mb-3">
                        <label for="discord-template" class="form-label">Custom Message Template (Optional)</label>
                        <textarea class="form-control font-monospace" id="discord-template" rows="6" placeholder="Ã°Å¸Å¡Â¨ Security Alert&#10;&#10;Signature: {signature}&#10;Category: {category}&#10;Severity: {severity}&#10;Source: {src_ip}:{src_port}&#10;Destination: {dest_ip}:{dest_port}&#10;Protocol: {protocol}"></textarea>
                        <div class="form-text">
                            Available variables: {signature}, {category}, {severity}, {src_ip}, {src_port}, {dest_ip}, {dest_port}, {protocol}, {timestamp}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate Limiting</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="discord-rate-limit-messages" class="form-label small">Max Messages</label>
                                <input type="number" class="form-control form-control-sm" id="discord-rate-limit-messages" value="30" min="1" max="100">
                                <div class="form-text">Maximum messages allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="discord-rate-limit-interval" class="form-label small">Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="discord-rate-limit-interval" value="60" min="10" max="3600">
                                <div class="form-text">Time window in seconds</div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Default: 30 messages per 60 seconds
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-info" id="discord-test-btn">
                            <i class="fas fa-paper-plane"></i> Test Send Message
                        </button>
                    </div>
                </div>
                <div id="telegram-fields" class="integration-fields d-none">
                    <div class="mb-3">
                        <label for="telegram-bot-token" class="form-label">Bot Token</label>
                        <input type="text" class="form-control" id="telegram-bot-token" placeholder="123456789:ABCDEF...">
                    </div>
                    <div class="mb-3">
                        <label for="telegram-chat-id" class="form-label">Chat ID</label>
                        <input type="text" class="form-control" id="telegram-chat-id" placeholder="@channel or numeric chat id">
                        <div class="form-text">Use the numeric chat ID or channel handle for the target destination.</div>
                    </div>
                    <div class="mb-3">
                        <label for="telegram-template" class="form-label">Custom Message Template (Optional)</label>
                        <textarea class="form-control font-monospace" id="telegram-template" rows="6" placeholder="Ã°Å¸Å¡Â¨ Security Alert&#10;&#10;Signature: {signature}&#10;Category: {category}&#10;Severity: {severity}&#10;Source: {src_ip}:{src_port}&#10;Destination: {dest_ip}:{dest_port}&#10;Protocol: {protocol}"></textarea>
                        <div class="form-text">
                            Available variables: {signature}, {category}, {severity}, {src_ip}, {src_port}, {dest_ip}, {dest_port}, {protocol}, {timestamp}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate Limiting</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="telegram-rate-limit-messages" class="form-label small">Max Messages</label>
                                <input type="number" class="form-control form-control-sm" id="telegram-rate-limit-messages" value="20" min="1" max="100">
                                <div class="form-text">Maximum messages allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="telegram-rate-limit-interval" class="form-label small">Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="telegram-rate-limit-interval" value="60" min="10" max="3600">
                                <div class="form-text">Time window in seconds</div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Default: 20 messages per 60 seconds
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-info" id="telegram-test-btn">
                            <i class="fas fa-paper-plane"></i> Test Send Message
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="integration-save-btn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuration Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="config-modal-message">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


{% include 'config/modals/app-layer.html' %}

{% include 'config/modals/outputs.html' %}

{% include 'config/modals/logging.html' %}

{% include 'config/modals/detection.html' %}




{% include 'config/modals/packet-capture.html' %}



{% include 'config/modals/stream.html' %}



{% include 'config/modals/host.html' %}

{% include 'config/modals/ips.html' %}

{% include 'config/modals/interface.html' %}

{% include 'config/modals/vars.html' %}

{% endblock %}
{% block scripts %}
<!-- Configuration Module Scripts -->
<script src="{{ url_for('static', filename='js/config/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/app-layer.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/outputs.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/stream.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/vars.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/host.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/ips.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/interfaces.js') }}"></script>
<script src="{{ url_for('static', filename='js/config/packet-capture.js') }}"></script>

<script>
const integrationDefaults = {
    discord: {
        enabled: false,
        webhook_url: '',
        message_template: '',
        rate_limit_messages: 30,
        rate_limit_interval: 60
    },
    telegram: {
        enabled: false,
        bot_token: '',
        chat_id: '',
        message_template: '',
        rate_limit_messages: 20,
        rate_limit_interval: 60
    }
};
let integrationSettings = {};
let integrationHashes = {};
let integrationModalInstance = null;
let afPacketConfig = {};
let streamConfig = {};
let varsConfig = {};

// Utility functions moved to utils.js
// Functions: escapeHtml(), toBoolean()
// See: static/js/config/utils.js

function loadIntegrationSettings() {
    $.get('/api/integration', function(response) {
        if (response.success && response.settings) {
            integrationSettings = response.settings;
            integrationHashes = response.hashes || {};
        }
    }).fail(function(xhr) {
        console.warn('Failed to load integration settings', xhr.responseText || xhr.statusText);
    });
}
function getIntegrationData(name) {
    const defaults = integrationDefaults[name] || {};
    const stored = integrationSettings[name] || {};
    return Object.assign({}, defaults, stored);
}
function resetIntegrationFeedback() {
    $('#integration-error').addClass('d-none').text('');
    $('#integration-success').addClass('d-none').text('');
}
function hideIntegrationHash() {
    $('#integration-hash-wrapper').addClass('d-none');
    $('#integration-hash-value').text('-');
}

function updateIntegrationHashDisplay(info) {
    if (info && info.config_hash) {
        $('#integration-hash-wrapper').removeClass('d-none');
        $('#integration-hash-value').text(info.config_hash);
    } else {
        hideIntegrationHash();
    }
}
function setIntegrationFeedback(message, type) {
    if (!message) {
        resetIntegrationFeedback();
        return;
    }
    if (type === 'success') {
        $('#integration-success').removeClass('d-none').text(message);
        $('#integration-error').addClass('d-none').text('');
    } else {
        $('#integration-error').removeClass('d-none').text(message);
        $('#integration-success').addClass('d-none').text('');
    }
}
function toggleIntegrationFields(name) {
    $('.integration-fields').addClass('d-none');
    if (name === 'discord') {
        $('#discord-fields').removeClass('d-none');
    } else if (name === 'telegram') {
        $('#telegram-fields').removeClass('d-none');
    }
}
function openIntegrationModal(name) {
    const normalized = (name || '').toLowerCase();
    const data = getIntegrationData(normalized);
    if (!integrationModalInstance) {
        integrationModalInstance = new bootstrap.Modal(document.getElementById('integrationModal'));
    }
    $('#integration-name').val(normalized);
    $('#integrationModalLabel').text(normalized === 'telegram' ? 'Telegram Integration' : 'Discord Integration');
    $('#integration-enabled').prop('checked', !!data.enabled);
    $('#discord-webhook').val(data.webhook_url || '');
    $('#discord-template').val(data.message_template || '');
    $('#discord-rate-limit-messages').val(data.rate_limit_messages || 30);
    $('#discord-rate-limit-interval').val(data.rate_limit_interval || 60);
    $('#telegram-bot-token').val(data.bot_token || '');
    $('#telegram-chat-id').val(data.chat_id || '');
    $('#telegram-template').val(data.message_template || '');
    $('#telegram-rate-limit-messages').val(data.rate_limit_messages || 20);
    $('#telegram-rate-limit-interval').val(data.rate_limit_interval || 60);
    updateIntegrationHashDisplay(integrationHashes[normalized]);
    toggleIntegrationFields(normalized);
    resetIntegrationFeedback();
    integrationModalInstance.show();
}
function collectIntegrationPayload(name) {
    const normalized = (name || '').toLowerCase();
    const payload = { enabled: $('#integration-enabled').is(':checked') };
    if (normalized === 'discord') {
        payload.webhook_url = ($('#discord-webhook').val() || '').trim();
        payload.message_template = ($('#discord-template').val() || '').trim();
        payload.rate_limit_messages = parseInt($('#discord-rate-limit-messages').val() || 30);
        payload.rate_limit_interval = parseInt($('#discord-rate-limit-interval').val() || 60);
    } else if (normalized === 'telegram') {
        payload.bot_token = ($('#telegram-bot-token').val() || '').trim();
        payload.chat_id = ($('#telegram-chat-id').val() || '').trim();
        payload.message_template = ($('#telegram-template').val() || '').trim();
        payload.rate_limit_messages = parseInt($('#telegram-rate-limit-messages').val() || 20);
        payload.rate_limit_interval = parseInt($('#telegram-rate-limit-interval').val() || 60);
    }
    return payload;
}
function setIntegrationSaving(isSaving) {
    const $btn = $('#integration-save-btn');
    if (isSaving) {
        if (!$btn.data('original-html')) {
            $btn.data('original-html', $btn.html());
        }
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');
    } else {
        const original = $btn.data('original-html');
        if (original) {
            $btn.html(original);
        }
        $btn.prop('disabled', false);
    }
}
function saveIntegration() {
    const name = $('#integration-name').val();
    if (!name) {
        return;
    }
    const payload = collectIntegrationPayload(name);
    setIntegrationSaving(true);
    resetIntegrationFeedback();
    $.ajax({
        url: '/api/integration/' + name,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
            if (response.success) {
                integrationSettings[name] = response.settings || payload;
                if (response.hash) {
                    integrationHashes[name] = response.hash;
                    updateIntegrationHashDisplay(response.hash);
                } else if (integrationHashes[name]) {
                    updateIntegrationHashDisplay(integrationHashes[name]);
                } else {
                    hideIntegrationHash();
                }
                setIntegrationFeedback('Settings saved successfully.', 'success');
            } else {
                setIntegrationFeedback(response.message || 'Failed to save settings.', 'error');
            }
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || xhr.responseText || 'Failed to save settings.';
            setIntegrationFeedback(message, 'error');
        },
        complete: function() {
            setIntegrationSaving(false);
        }
    });
}
$('#integration-save-btn').click(saveIntegration);
$('#integrationModal').on('hidden.bs.modal', function() {
    $('#integration-name').val('');
    $('#integration-enabled').prop('checked', false);
    $('#discord-webhook, #discord-template, #telegram-bot-token, #telegram-chat-id, #telegram-template').val('');
    $('#discord-rate-limit-messages').val(30);
    $('#discord-rate-limit-interval').val(60);
    $('#telegram-rate-limit-messages').val(20);
    $('#telegram-rate-limit-interval').val(60);
    hideIntegrationHash();
    resetIntegrationFeedback();
    setIntegrationSaving(false);
});

// Test send message functions
function testSendMessage(integration) {
    const name = integration.toLowerCase();
    let payload = {};

    if (name === 'telegram') {
        const bot_token = $('#telegram-bot-token').val().trim();
        const chat_id = $('#telegram-chat-id').val().trim();
        const template = $('#telegram-template').val().trim();

        if (!bot_token || !chat_id) {
            setIntegrationFeedback('Please fill in Bot Token and Chat ID first', 'error');
            return;
        }

        if (template) {
            payload.message = template;
        }
    } else if (name === 'discord') {
        const webhook_url = $('#discord-webhook').val().trim();
        const template = $('#discord-template').val().trim();

        if (!webhook_url) {
            setIntegrationFeedback('Please fill in Webhook URL first', 'error');
            return;
        }

        if (template) {
            payload.message = template;
        }
    }

    resetIntegrationFeedback();

    // Show loading state
    const btnId = '#' + name + '-test-btn';
    const $btn = $(btnId);
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Sending...');

    // First save the settings to ensure we test with current config
    const savePayload = collectIntegrationPayload(name);

    $.ajax({
        url: '/api/integration/' + name,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(savePayload),
        success: function(response) {
            // Now send test message
            $.ajax({
                url: '/api/integration/' + name + '/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(data) {
                    if (data.success) {
                        setIntegrationFeedback(data.message, 'success');
                    } else {
                        setIntegrationFeedback(data.message, 'error');
                    }
                },
                error: function(xhr) {
                    const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to send test message';
                    setIntegrationFeedback(message, 'error');
                },
                complete: function() {
                    $btn.prop('disabled', false).html(originalHtml);
                }
            });
        },
        error: function(xhr) {
            const message = (xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save settings';
            setIntegrationFeedback(message, 'error');
            $btn.prop('disabled', false).html(originalHtml);
        }
    });
}

$('#telegram-test-btn').click(function() {
    testSendMessage('telegram');
});

$('#discord-test-btn').click(function() {
    testSendMessage('discord');
});

// Card click handlers
$('.config-card').click(function() {
    const searchTerm = $(this).data('search');

    if (searchTerm === 'packet-capture') {
        openPacketCaptureModal();
    } else if (searchTerm === 'af-packet') {
        // Backward compatibility - redirect to packet capture
        openPacketCaptureModal('af-packet');
    } else if (searchTerm === 'app-layer') {
        openAppLayerModal();
    } else if (searchTerm === 'outputs') {
        openOutputsModal();
    } else if (searchTerm === 'logging') {
        openLoggingModal();
    } else if (searchTerm === 'vars') {
        openVarsModal();
    } else if (searchTerm === 'detection') {
        openDetectionModal();
    } else if (searchTerm === 'stream') {
        openStreamModal();
    } else if (searchTerm === 'host') {
        openHostModal();
    } else if (searchTerm === 'ips') {
        openIpsModal();
    } else if (searchTerm === 'interface') {
        openInterfaceModal();
    }
});

$('.integration-card').click(function() {
    const integration = $(this).data('integration');
    openIntegrationModal(integration);
});

loadIntegrationSettings();

// App Layer Configuration (Moved to app-layer.js)
// Outputs Configuration (Moved to outputs.js)
// ==================== Packet Capture (Moved to packet-capture.js) ====================
// Functions: openPacketCaptureModal(), loadPacketCaptureConfig(), renderPacketCapture()
// See: static/js/config/packet-capture.js

// Stream Configuration (Moved to stream.js)
// Variables Configuration (Moved to vars.js)
// Host Configuration (Moved to host.js)
// IPS/Preventive Configuration (Moved to ips.js)
// Interface Configuration (Moved to interfaces.js)
</script>
{% endblock %}




